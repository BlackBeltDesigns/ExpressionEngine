#!/bin/bash

STASH_NAME=`git stash create`;
if [ "$STASH_NAME" == "" ]; then
	STASH_NAME="HEAD"
fi
git archive --format=tar -o ee.tar $STASH_NAME

# Absolutely have to have the git folder available in the archive?
#tar --append --file=ee.tar .git

IMAGE_NAME="ellislab/eecms-test:latest"

function remove_app_volume {
	CONTAINER_ID=`docker ps -a | grep eecms-test-vol | cut -d " " -f 1`
	docker rm $CONTAINER_ID
}

function create_app_volume {
	[ "$(docker ps -a | grep eecms-test-vol)" ] && remove_app_volume

	docker create -v /app --name eecms-test-vol $IMAGE_NAME /bin/true
}

function commit_container_changes {
	CONTAINER_ID=`docker ps -l -q`
	docker commit $CONTAINER_ID $IMAGE_NAME
}

function remove_last_container {
	CONTAINER_ID=`docker ps -l -q`
	docker rm $CONTAINER_ID
}

STATUS=0

# Open a prompt on the Docker container to fiddle
if [ "$1" == "prompt" ]; then
	docker run -t -i -p 8080:80 -v $(pwd):/app $IMAGE_NAME /bin/bash
# Install or update gems
elif [ "$1" == "updategems" ]; then
	docker run -t -i -v $(pwd):/app $IMAGE_NAME ./updategems.sh

	commit_container_changes
	remove_last_container
else
	create_app_volume
	docker cp ee.tar eecms-test-vol:/app

	# Have to quote this to get multiple arguments working for run.sh
	DOCKER_CMD="docker run -t -i -v /app --volumes-from eecms-test-vol $IMAGE_NAME /bin/bash -c \"./run.sh $@\""
	eval $DOCKER_CMD

	((STATUS+=$?))

	mkdir /tmp/artifacts > /dev/null
	docker cp eecms-test-vol:/app/artifacts/. /tmp/artifacts

	remove_last_container
fi

rm ee.tar

exit $STATUS
