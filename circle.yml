machine:
  timezone: America/New_York
  ruby:
    version: 2.2.3
  node:
    version: 5.5.0
  hosts:
    ee2.test: 127.0.0.1
  environment:
    php_versions: 5.4.37 5.5.21 5.6.14 7.0.4

dependencies:
  pre:
    - npm install -g gulp
    - sudo apt-get -y install xvfb chromium-chromedriver
    - sudo cp /usr/lib/chromium-browser/chromedriver /usr/local/bin/

  override:
    - "cd tests/rspec && bundle install --without development --deployment"
    - "cd system/ee/EllisLab/Tests && composer install --prefer-source --no-interaction"
    - "cd system/ee/installer/updater/EllisLab/Tests && composer install --prefer-source --no-interaction"
    - npm install
  post:
    - cp tests/circleci/circleci-apache /etc/apache2/sites-available
    - a2ensite circleci-apache
    - sudo service apache2 restart
  cache_directories:
    - "tests/rspec/vendor/bundle"
    - "system/ee/EllisLab/Tests/vendor"
    - "system/ee/installer/updater/EllisLab/Tests/"

checkout:
  post:
    - git config --global user.email "you@example.com"
    - git config --global user.name "Your Name"
    - chmod +x tests/circleci/runtests.sh

test:
  override:
    - "rvm use 2.2.3 && ./tests/circleci/runtests.sh":
        parallel: true
