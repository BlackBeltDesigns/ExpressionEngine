machine:
  timezone: America/New_York
  ruby:
    version: 2.2.3
  hosts:
    ee2.test: 127.0.0.1
  environment:
    php_versions: 5.3.10 5.3.25 5.4.37 5.5.21 5.6.14
    QMAKE: /opt/qt54/bin/qmake

dependencies:
  pre:
  	- sudo apt-get install apt -y
    - sudo add-apt-repository ppa:beineri/opt-qt542 -y
    - sudo apt-get update -y; true
    - sudo apt-get install -y qt54webkit libwebkit-dev libgstreamer0.10-dev
    - echo "/opt/qt54/bin/qt54-env.sh" >> ~/.circlerc
  override:
    - "cd tests/rspec && bundle install --without development --deployment"
    - "cd system/ee/EllisLab/Tests && composer install --prefer-source --no-interaction"
  post:
    - cp tests/circleci/circleci-apache /etc/apache2/sites-available
    - a2ensite circleci-apache
    - sudo service apache2 restart
  cache_directories:
    - "tests/rspec/vendor/bundle"
    - "system/ee/EllisLab/Tests/vendor"

checkout:
  post:
    - cp tests/circleci/config.php system/user/config/
    - cp tests/circleci/license.key system/user/config/
    - chmod 666 system/user/config/config.php
    - chmod -R 777 system/user/cache
    - chmod -R 777 system/user/templates
    - chmod -R 777 system/ee/legacy/translations
    - chmod 777 tests/rspec/support/tmp
    - chmod -R 777 tests/rspec/support/file-sync/uploads
    - chmod -R 777 images
    - chmod -R 777 themes/ee/site/agile_records/images/uploads
    - chmod +x tests/circleci/runtests.sh

test:
  override:
    - "rvm use 2.2.3 && ./tests/circleci/runtests.sh":
        parallel: true
