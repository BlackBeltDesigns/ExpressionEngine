/*!
 * ExpressionEngine - by EllisLab
 *
 * @package		ExpressionEngine
 * @author		EllisLab Dev Team
 * @copyright	Copyright (c) 2003 - 2014, EllisLab, Inc.
 * @license		https://ellislab.com/expressionengine/user-guide/license.html
 * @link		http://ellislab.com
 * @since		Version 3.0
 * @filesource
 */
/* This file exposes three callback functions:
 *
 * EE.manager.showPrefsRow and EE.manager.hidePrefsRow and
 * EE.manager.refreshPrefs
 */
/*jslint browser: true, onevar: true, undef: true, nomen: true, eqeqeq: true, plusplus: false, bitwise: true, regexp: false, strict: true, newcap: true, immed: true */
/*global $, jQuery, EE, window, document, console, alert */
"use strict";function loadSettingsModal(t,e){$("div.box",t).html(e),
// Bind validation
EE.cp.formValidation.init(t),$("form",t).on("submit",function(){return $.ajax({type:"POST",url:this.action,data:$(this).serialize()+"&save_modal=yes",dataType:"json",success:function(e){console.log(e),"success"==e.messageType?t.trigger("modal:close"):loadSettingsModal(t,e.body)}}),!1})}!function(t){var e,a,i,n=function(n,l){i=function(t){var a={modal:e,input_value:l.input_value,input_name:l.input_name,input_img:l.input_img};l.callback(t,a)},t.get(n,function(t){if(e.find("div.box").html(t),"undefined"!=typeof l.selected){var a=e.find('tbody *[data-id="'+l.selected+'"]');a.addClass("selected"),"A"==a.prop("tagName")?a.parents("td").addClass("selected"):a.parents("tr").addClass("selected")}}),t(".modal-file").off("click",".filepicker-item, tbody > tr"),t(".modal-file").on("click",".filepicker-item, tbody > tr",function(i){i.stopPropagation();var n=t(this).data("id"),s=t(this).data("url");a.data("selected",n),e.find("tbody .selected").toggleClass("selected"),l.selected=n;var u=t(this);if("A"==u.prop("tagName")?u.parents("td").addClass("selected"):u.parents("tr").addClass("selected"),0==l.ajax){var c={modal:e,input_value:l.input_value,input_name:l.input_name,input_img:l.input_img};l.callback(t(this),c)}else t.ajax({url:s,success:function(t){var a={modal:e,input_value:l.input_value,input_name:l.input_name,input_img:l.input_img};l.callback(t,a)},dataType:"json"})}),t(".modal-file").on("click",'.filters a:not([href=""]), .paginate a:not([href=""]), thead a:not([href=""])',function(e){e.preventDefault(),t(this).parents("div.box").load(t(this).attr("href"))}),t(".modal-file").on("click",".tbl-search a",function(a){a.preventDefault(),t("div.box",e).html("<iframe></iframe>"),t("iframe",e).css("border","none"),t("iframe",e).css("width","100%"),t("iframe",e).load(function(a){var n=t(this).contents().find("body"),l=n;l.hide(),t(n).find("pre").length&&(n=t(n).find("pre")),n=n.html();try{n=JSON.parse(n),i(n)}catch(a){l.show();var s=t(this).contents().find("body").height();t(".box",e).height(s),t(this).height(s)}}),t("iframe",e).attr("src",t(this).attr("href"))})};t.fn.FilePicker=function(i){return this.off("click"),this.each(function(){t(this).on("click",function(){a=t(this),i.url=t(this).attr("href"),i.rel=t(this).attr("rel"),i.input_value?i.input_value=t(i.input_value):i.input_value=t('input[name="'+t(this).data("input-value")+'"], textarea[name="'+t(this).data("input-value")+'"]'),i.input_name?i.input_name=t(i.input_name):i.input_name=t("#"+t(this).data("input-name")),i.input_img?i.input_img=t(i.input_img):i.input_img=t("#"+t(this).data("input-image")),"selected"in i||(i.selected=t(this).data("selected")),e=t("."+i.rel),n(i.url,i)})})},t(document).ready(function(){e=t("."+t(this).attr("rel")),t(".filepicker").click(function(e){var l={};l.input_value=t('input[name="'+t(this).data("input-value")+'"], textarea[name="'+t(this).data("input-value")+'"]'),l.input_name=t("#"+t(this).data("input-name")),l.input_img=t("#"+t(this).data("input-image")),l.selected=t(this).data("selected"),callback_name=t(this).data("callback"),picker_url=t(this).attr("href"),a=t(this),i="undefined"!=typeof callback_name&&0!==callback_name.length?function(t,e){for(var a=[t,e],i=callback_name.split("."),n=i.pop(),l=window,s=0;s<i.length;s++)l=l[i[s]];return l[n].apply(this,a)}:function(t,e){e.modal.find(".m-close").click(),e.input_value.val(t.file_id),e.input_name.html(t.file_name),e.input_img.html("<img src='"+t.path+"' />")},l.url=picker_url,l.callback=i,n(picker_url,l)})})}(jQuery);