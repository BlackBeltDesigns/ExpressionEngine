/*!
// ----------------------------------------------------------------------------
// markItUp! Universal MarkUp Engine, JQuery plugin
// v 1.1.7
// Dual licensed under the MIT and GPL licenses.
// ----------------------------------------------------------------------------
// Copyright (C) 2007-2010 Jay Salvat
// http://markitup.jaysalvat.com/
// ----------------------------------------------------------------------------
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
// 
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
// ----------------------------------------------------------------------------
*/

(function(c){c.fn.markItUp=function(l,i){var b,f,h,r;f=h=r=!1;b={id:"",nameSpace:"",root:"",previewInWindow:"",previewAutoRefresh:!0,previewPosition:"after",previewTemplatePath:"~/templates/preview.html",previewParserPath:"",previewParserVar:"data",resizeHandle:!0,beforeInsert:"",afterInsert:"",onEnter:{},onShiftEnter:{},onCtrlEnter:{},onTab:{},markupSet:[{}]};c.extend(b,l,i);b.root||c("script").each(function(f,h){miuScript=c(h).get(0).src.match(/(.*)jquery\.markitup(\.pack)?\.js$/);null!==miuScript&&
(b.root=miuScript[1])});return this.each(function(){function i(a,c){return c?a.replace(/("|')~\//g,"$1"+b.root):a.replace(/^~\//,b.root)}function l(a){var b=c("<ul></ul>"),d=0;c("li:hover > ul",b).css("display","block");c.each(a,function(){var a=this,e="",g,f;g=a.key?(a.name||"")+" [Ctrl+"+a.key+"]":a.name||"";key=a.key?'accesskey="'+a.key+'"':"";if(a.separator)e=c('<li class="markItUpSeparator">'+(a.separator||"")+"</li>").appendTo(b);else{d++;for(f=u.length-1;0<=f;f--)e+=u[f]+"-";e=c('<li class="markItUpButton markItUpButton'+
e+d+" "+(a.className||"")+'"><a href="" '+key+' title="'+g+'">'+(a.name||"")+"</a></li>").bind("contextmenu",function(){return!1}).click(function(){return!1}).mousedown(function(){a.call&&eval(a.call)();setTimeout(function(){t(a)},1);return!1}).hover(function(){c("> ul",this).show();c(document).one("click",function(){c("ul ul",w).hide()})},function(){c("> ul",this).hide()}).appendTo(b);a.dropMenu&&(u.push(d),c(e).addClass("markItUpDropMenu").append(l(a.dropMenu)))}});u.pop();return b}function k(a){c.isFunction(a)&&
(a=a(q));a?(a=a.toString(),a=a.replace(/\(\!\(([\s\S]*?)\)\!\)/g,function(a,c){var b=c.split("|!|");return!0===r?void 0!==b[1]?b[1]:b[0]:void 0===b[1]?"":b[0]}),a=a.replace(/\[\!\[([\s\S]*?)\]\!\]/g,function(a,c){var b=c.split(":!:");if(!0===v)return!1;value=prompt(b[0],b[1]?b[1]:"");null===value&&(v=!0);return value})):a="";return a}function x(a){openWith=k(m.openWith);placeHolder=k(m.placeHolder);replaceWith=k(m.replaceWith);closeWith=k(m.closeWith);block=""!==replaceWith?openWith+replaceWith+closeWith:
""===selection&&""!==placeHolder?openWith+placeHolder+closeWith:openWith+(a||selection)+closeWith;return{block:block,openWith:openWith,replaceWith:replaceWith,placeHolder:placeHolder,closeWith:closeWith}}function t(a){var s,n;q=m=a;y();c.extend(q,{line:"",root:b.root,textarea:g,selection:selection||"",caretPosition:e,ctrlKey:f,shiftKey:h,altKey:r});k(b.beforeInsert);k(m.beforeInsert);!0===f&&!0===h&&k(m.beforeMultiInsert);c.extend(q,{line:1});if(!0===f&&!0===h){lines=selection.split(/\r?\n/);a=0;
s=lines.length;for(n=0;n<s;n++)""!==c.trim(lines[n])?(c.extend(q,{line:++a,selection:lines[n]}),lines[n]=x(lines[n]).block):lines[n]="";string={block:lines.join("\n")};start=e;a=string.block.length+(c.browser.opera?s:0)}else!0===f?(string=x(selection),start=e+string.openWith.length,a=string.block.length-string.openWith.length-string.closeWith.length,a-=A(string.block)):!0===h?(string=x(selection),start=e,a=string.block.length,a-=A(string.block)):(string=x(selection),start=e+string.block.length,a=
0,start-=A(string.block));""===selection&&""===string.replaceWith&&(j+=B(string.block),start=e+string.openWith.length,a=string.block.length-string.openWith.length-string.closeWith.length,j=d.val().substring(e,d.val().length).length,j-=B(d.val().substring(0,e)));c.extend(q,{caretPosition:e,scrollPosition:z});string.block!==selection&&!1===v?(s=string.block,document.selection?document.selection.createRange().text=s:d.val(d.val().substring(0,e)+s+d.val().substring(e+selection.length,d.val().length)),
C(start,a)):j=-1;y();c.extend(q,{line:"",selection:selection});!0===f&&!0===h&&k(m.afterMultiInsert);k(m.afterInsert);k(b.afterInsert);p&&b.previewAutoRefresh&&(""!==b.previewParserPath?c.ajax({type:"POST",url:b.previewParserPath,data:b.previewParserVar+"="+encodeURIComponent(d.val()),success:function(a){D(i(a,1))}}):G||c.ajax({url:b.previewTemplatePath,success:function(a){D(i(a,1).replace(/<\!-- content --\>/g,d.val()))}}));h=r=f=v=!1}function B(a){return c.browser.opera?a.length-a.replace(/\n*/g,
"").length:0}function A(a){return c.browser.msie?a.length-a.replace(/\r*/g,"").length:0}function C(a,b){if(g.createTextRange){if(c.browser.opera&&9.5<=c.browser.version&&0==b)return!1;range=g.createTextRange();range.collapse(!0);range.moveStart("character",a);range.moveEnd("character",b);range.select()}else g.setSelectionRange&&g.setSelectionRange(a,a+b);g.scrollTop=z;g.focus()}function y(){g.focus();z=g.scrollTop;if(document.selection)if(selection=document.selection.createRange().text,c.browser.msie){var a=
document.selection.createRange(),b=a.duplicate();b.moveToElementText(g);for(e=-1;b.inRange(a);)b.moveStart("character"),e++}else e=g.selectionStart;else e=g.selectionStart,selection=d.val().substring(e,g.selectionEnd);return selection}function D(a){if(p.document){try{sp=p.document.documentElement.scrollTop}catch(c){sp=0}p.document.open();p.document.write(a);p.document.close();p.document.documentElement.scrollTop=sp}b.previewInWindow&&p.focus()}function E(a){h=a.shiftKey;r=a.altKey;f=!a.altKey||!a.ctrlKey?
a.ctrlKey:!1;if("keydown"===a.type){if(!0===f&&(li=c('a[accesskey="'+String.fromCharCode(a.keyCode)+'"]',w).parent("li"),0!==li.length))return f=!1,setTimeout(function(){li.triggerHandler("mousedown")},1),!1;if(13===a.keyCode||10===a.keyCode){if(!0===f)return f=!1,t(b.onCtrlEnter),b.onCtrlEnter.keepDefault;if(!0===h)return h=!1,t(b.onShiftEnter),b.onShiftEnter.keepDefault;t(b.onEnter);return b.onEnter.keepDefault}if(9===a.keyCode){if(!0==h||!0==f||!0==r)return!1;if(-1!==j)return y(),j=d.val().length-
j,C(j,0),j=-1,!1;t(b.onTab);return b.onTab.keepDefault}}}var d,g,u,z,e,j,m,q,w,F,p,G,v;d=c(this);g=this;u=[];v=!1;z=e=0;j=-1;b.previewParserPath=i(b.previewParserPath);b.previewTemplatePath=i(b.previewTemplatePath);nameSpace=id="";b.id?id='id="'+b.id+'"':d.attr("id")&&(id='id="markItUp'+d.attr("id").substr(0,1).toUpperCase()+d.attr("id").substr(1)+'"');b.nameSpace&&(nameSpace='class="'+b.nameSpace+'"');d.wrap("<div "+nameSpace+"></div>");d.wrap("<div "+id+' class="markItUp"></div>');d.wrap('<div class="markItUpContainer"></div>');
d.addClass("markItUpEditor");w=c('<div class="markItUpHeader"></div>').insertBefore(d);c(l(b.markupSet)).appendTo(w);F=c('<div class="markItUpFooter"></div>').insertAfter(d);!0===b.resizeHandle&&!0!==c.browser.safari&&(resizeHandle=c('<div class="markItUpResizeHandle"></div>').insertAfter(d).bind("mousedown",function(a){var b=d.height(),e=a.clientY,f,g;f=function(a){d.css("height",Math.max(20,a.clientY+b-e)+"px");return!1};g=function(){c("html").unbind("mousemove",f).unbind("mouseup",g);return!1};
c("html").bind("mousemove",f).bind("mouseup",g)}),F.append(resizeHandle));d.keydown(E).keyup(E);d.bind("insertion",function(a,b){!1!==b.target&&y();g===c.markItUp.focused&&t(b)});d.focus(function(){c.markItUp.focused=this})})};c.fn.markItUpRemove=function(){return this.each(function(){var l=c(this).unbind().removeClass("markItUpEditor");l.parent("div").parent("div.markItUp").parent("div").replaceWith(l)})};c.markItUp=function(l){var i={target:!1};c.extend(i,l);if(i.target)return c(i.target).each(function(){c(this).focus();
c(this).trigger("insertion",[i])});c("textarea").trigger("insertion",[i])}})(jQuery);
