/*!
 * ExpressionEngine - by EllisLab
 *
 * @package		ExpressionEngine
 * @author		ExpressionEngine Dev Team
 * @copyright	Copyright (c) 2003 - 2011, EllisLab, Inc.
 * @license		http://expressionengine.com/user_guide/license.html
 * @link		http://expressionengine.com
 * @since		Version 2.0
 * @filesource
 */

(function(a){function i(b,c){isNaN(c)&&(c=0);if(isNaN(b))g[b.id]=b;else if(typeof g[b]=="undefined")return a.ee_filebrowser.endpoint_request("directory_contents",{directory:b},function(a){g[b]=a;i(b,c)});else b=g[b];if(!(!b in f)){f[b.id]=b.files;a.each(b.files,function(a,c){c.img_id=a+"";c.directory=b.id+"";c.is_image=!(c.mime_type.indexOf("image")<0)});var d=a("#tableView").detach(),h=a("#viewSelectors").detach();d.find("tbody").empty();a("#file_chooser_body").empty().append(d);a("#file_chooser_footer").empty().append(h);
d=j=="list"?k:l;h={};c*=d;if(j!="list"){var q=p(b),e=b.images.slice(c,c+d);a("#tableView").hide();a.tmpl("thumb",e).appendTo("#file_chooser_body");a("a.file_chooser_thumbnail:nth-child(9n+2)").addClass("first");a("a.file_chooser_thumbnail:nth-child(9n+1)").addClass("last");a("a.file_chooser_thumbnail:gt(26)").addClass("last_row");h.pages_total=q.length}else e=b.files.slice(c,c+d),a("#tableView").show(),a.tmpl("fileRow",e).appendTo("#tableView tbody");r(b,c,d,h)}}function r(b,c,d,h){for(var e=h.pages_total?
h.pages_total:b.files.length,g=[],f=0,k=Math.ceil(e/d);f<k;f++)g[f]=f+1;a.extend(h,{directory:b.id,pages_total:e,pages_from:c+1,pages_to:c+d>e?e:c+d,pages_current:Math.floor(c/d)+1,pages:g});a.tmpl("pagination",h).appendTo("#file_chooser_footer").find("#view_type").val(j).change(function(){a("#file_chooser_body").removeClass("list thumb").addClass(this.value);j=this.value;i(a("#dir_choice").val())}).end().find("select[name=category]").replaceWith(b.categories)}function p(a){if(typeof a.images=="undefined"){for(var c=
[],d=0,e=a.files.length;d<e;d++)a.files[d].is_image&&c.push(a.files[d]);a.images=c;g[a.id].images=c}return a.images}function m(b){f[b]==""&&a.ee_filebrowser.endpoint_request("directory_contents",{directory:b},i)}function s(){e.dialog({width:968,height:610,resizable:!1,position:["center","center"],modal:!0,draggable:!0,title:EE.filebrowser.window_title,autoOpen:!1,zIndex:99999,open:function(){var b=a("#dir_choice").val();m(b)}});j="list";a("#dir_choice").change(function(){m(this.value);i(this.value,
0)});a.template("fileRow",a("<tbody />").append(a("#rowTmpl").remove().attr("id","")));a.template("noFilesRow",a("#noFilesRowTmpl").remove());a.template("pagination",a("#paginationTmpl").remove());a.template("thumb",a("#thumbTmpl").remove());a("#upload_form",e).submit(a.ee_filebrowser.upload_start);a("#file_chooser_body",e).addClass(j)}var n=0,f,e,k,l,o,g={},j;a.ee_filebrowser=function(){k=14;l=36;a.ee_filebrowser.endpoint_request("setup",function(b){f={};e=a(b.manager).appendTo(document.body);for(var c in b.directories)n||
(n=c),f[c]="";s();typeof a.ee_fileuploader!="undefined"&&a.ee_fileuploader({type:"fileuploader",open:function(){a.ee_fileuploader.set_directory_id(a("#dir_choice").val())},close:function(){a("#file_uploader").removeClass("upload_step_2").addClass("upload_step_1");a("#fileChooser").size()&&a.ee_filebrowser.reload_directory(a("#dir_choice").val())},trigger:"#fileChooser #upload_form input"})})};a.ee_filebrowser.endpoint_request=function(b,c,d){!d&&a.isFunction(c)&&(d=c,c={});c=a.extend(c,{action:b});
a.getJSON(EE.BASE+"&"+EE.filebrowser.endpoint_url+"&"+a.param(c),d)};a.ee_filebrowser.reload_directory=function(b){a.ee_filebrowser.endpoint_request("directory_contents",{directory:b},function(c){g[b]=c;a("#dir_choice").val()==b&&i(b)})};a.ee_filebrowser.add_trigger=function(b,c,d){!d&&a.isFunction(c)&&(d=c,c="userfile");a(b).click(function(){var b=this;a("#upload_file",e).attr("name",c);e.dialog("open");o=function(a){d.call(b,a,c)};return!1})};a.ee_filebrowser.placeImage=function(b,c){a.ee_filebrowser.clean_up(f[b][c],
"");return!1};a.ee_filebrowser.clean_up=function(b,c){a("#page_0 .items").html(c);e.dialog("close");o(b)};a.ee_filebrowser.setPage=i})(jQuery);
