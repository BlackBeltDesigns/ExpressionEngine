/*!
 * ExpressionEngine - by EllisLab
 *
 * @package		ExpressionEngine
 * @author		ExpressionEngine Dev Team
 * @copyright	Copyright (c) 2003 - 2011, EllisLab, Inc.
 * @license		http://expressionengine.com/user_guide/license.html
 * @link		http://expressionengine.com
 * @since		Version 2.0
 * @filesource
 */

(function(b){function l(a,c){if(isNaN(c))c=0;if(isNaN(a))m[a.id]=a;else if(typeof m[a]=="undefined")return b.ee_filebrowser.endpoint_request("directory_contents",{directory:a},function(g){m[a]=g;l(a,c)});else a=m[a];if(!(!a in j)){j[a.id]=a.files;o[a.id]=a.url;b.each(a.files,function(g,f){f.img_id=g+"";f.directory=a.id+"";f.is_image=!(f.mime_type.indexOf("image")<0);if(f.is_image)f.thumb=a.url+"/_thumbs/thumb_"+f.file_name});var d=b("#tableView").detach(),e=b("#viewSelectors").detach();d.find("tbody").empty();
b("#file_chooser_body").empty().append(d);b("#file_chooser_footer").empty().append(e);d=n=="list"?p:q;e={};c*=d;if(n!="list"){var h=u(a),k=a.images.slice(c,c+d);b("#tableView").hide();b.tmpl("thumb",k).appendTo("#file_chooser_body");b("a.file_chooser_thumbnail:nth-child(7n+2)").addClass("first");b("a.file_chooser_thumbnail:nth-child(7n+1)").addClass("last");e.pages_total=h.length}else{k=a.files.slice(c,c+d);b("#tableView").show();b.tmpl("fileRow",k).appendTo("#tableView tbody")}v(a,c,d,e)}}function v(a,
c,d,e){for(var h=e.pages_total?e.pages_total:a.files.length,k=[],g=0,f=Math.ceil(h/d);g<f;g++)k[g]=g+1;b.extend(e,{directory:a.id,pages_total:h,pages_from:c+1,pages_to:c+d>h?h:c+d,pages_current:Math.floor(c/d)+1,pages:k});b.tmpl("pagination",e).appendTo("#file_chooser_footer").find("#view_type").val(n).change(function(){n=this.value;l(b("#dir_choice").val())})}function u(a){if(typeof a.images=="undefined"){for(var c=[],d=0,e=a.files.length;d<e;d++)a.files[d].thumb&&c.push(a.files[d]);a.images=c;m[a.id].images=
c}return a.images}function r(a){j[a]==""&&b.ee_filebrowser.endpoint_request("directory_contents",{directory:a},l)}function w(){i.dialog({width:730,height:495,resizable:false,position:["center","center"],modal:true,draggable:true,title:EE.filebrowser.window_title,autoOpen:false,zIndex:99999,open:function(){var a=b("#dir_choice").val();r(a)}});n="list";b("#dir_choice").change(function(){r(this.value);l(this.value,0)});b.template("fileRow",b("<tbody />").append(b("#rowTmpl").remove().attr("id","")));
b.template("noFilesRow",b("#noFilesRowTmpl").remove());b.template("pagination",b("#paginationTmpl").remove());b.template("thumb",b("#thumbTmpl").remove());b("#upload_form",i).submit(b.ee_filebrowser.upload_start)}var s=0,j,o,i,p,q,t,m={},n;b.ee_filebrowser=function(){p=10;q=21;b.ee_filebrowser.endpoint_request("setup",function(a){j={};o={};i=b(a.manager).appendTo(document.body);for(var c in a.directories){s||(s=c);j[c]=""}w()})};b.ee_filebrowser.endpoint_request=function(a,c,d){if(!d&&b.isFunction(c)){d=
c;c={}}c=b.extend(c,{action:a});b.getJSON(EE.BASE+"&"+EE.filebrowser.endpoint_url+"&"+b.param(c),d)};b.ee_filebrowser.add_trigger=function(a,c,d){if(!d&&b.isFunction(c)){d=c;c="userfile"}b(a).click(function(){var e=this;b("#upload_file",i).attr("name",c);i.dialog("open");t=function(h){d.call(e,h,c)};return false})};b.ee_filebrowser.change_dim=function(a,c){var d;if(b("#cloned #constrain:checked").length!=0)if(c.attr("id")=="resize_width"){d=a.height/a.width;b("#resize_height").val(Math.floor(d*c.val()))}else{d=
a.width/a.height;b("#resize_width").val(Math.floor(d*c.val()))}};b.ee_filebrowser.submit_image_edit=function(a,c){b.ajax({type:"POST",url:EE.BASE+"&"+EE.filebrowser.endpoint_url+"&action=edit_image",data:b("#image_edit_form").serialize(),success:function(d){a.file_name=d;a.dimensions='width="'+a.width+'" height="'+a.height+'" ';b.ee_filebrowser.clean_up(a,c)},error:function(d){if(b.ee_notice)b.ee_notice(d.responseText,{type:"error"});else{d.responseText=d.responseText.replace(/<p>/,"");alert(d.responseText.replace(/<\/p>/,
""))}}})};b.ee_filebrowser.placeImage=function(a,c){b.ee_filebrowser.clean_up(j[a][c],"");return false};b.ee_filebrowser.clean_up=function(a,c){b("#page_0 .items").html(c);i.dialog("close");t(a)};b.ee_filebrowser=b.extend(b.ee_filebrowser,{upload_start:function(){b("input[name=upload_dir]").val(b("#dir_choice").val())},upload_success:function(a){b.ee_filebrowser.clean_up(a,"")},upload_error:function(a){b("#progress",i).hide();if(b.ee_notice)b.ee_notice(a.error,{type:"error"});else{a.error=a.error.replace(/<p>/,
"");alert(a.error.replace(/<\/p>/,""))}console.log(a)}});b.ee_filebrowser.setPage=l})(jQuery);
