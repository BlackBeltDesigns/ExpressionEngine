/*!
 * ExpressionEngine - by EllisLab
 *
 * @package		ExpressionEngine
 * @author		ExpressionEngine Dev Team
 * @copyright	Copyright (c) 2003 - 2011, EllisLab, Inc.
 * @license		http://expressionengine.com/user_guide/license.html
 * @link		http://expressionengine.com
 * @since		Version 2.0
 * @filesource
 */

(function(a){function i(b,c){if(isNaN(c))c=0;if(isNaN(b))j[b.id]=b;else if(typeof j[b]=="undefined")return a.ee_filebrowser.endpoint_request("directory_contents",{directory:b},function(f){j[b]=f;i(b,c)});else b=j[b];if(!(!b in k)){k[b.id]=b.files;o[b.id]=b.url;a.each(b.files,function(f,l){l.img_id=f+"";l.directory=b.id+"";l.is_image=!(l.mime_type.indexOf("image")<0)});var d=a("#tableView").detach(),e=a("#viewSelectors").detach();d.find("tbody").empty();a("#file_chooser_body").empty().append(d);a("#file_chooser_footer").empty().append(e);
d=m=="list"?p:q;e={};c*=d;if(m!="list"){var g=u(b),n=b.images.slice(c,c+d);a("#tableView").hide();a.tmpl("thumb",n).appendTo("#file_chooser_body");a("a.file_chooser_thumbnail:nth-child(9n+2)").addClass("first");a("a.file_chooser_thumbnail:nth-child(9n+1)").addClass("last");a("a.file_chooser_thumbnail:gt(26)").addClass("last_row");e.pages_total=g.length}else{n=b.files.slice(c,c+d);a("#tableView").show();a.tmpl("fileRow",n).appendTo("#tableView tbody")}v(b,c,d,e)}}function v(b,c,d,e){for(var g=e.pages_total?
e.pages_total:b.files.length,n=[],f=0,l=Math.ceil(g/d);f<l;f++)n[f]=f+1;a.extend(e,{directory:b.id,pages_total:g,pages_from:c+1,pages_to:c+d>g?g:c+d,pages_current:Math.floor(c/d)+1,pages:n});a.tmpl("pagination",e).appendTo("#file_chooser_footer").find("#view_type").val(m).change(function(){a("#file_chooser_body").removeClass("list thumb").addClass(this.value);m=this.value;i(a("#dir_choice").val())}).end().find("select[name=category]").replaceWith(b.categories)}function u(b){if(typeof b.images=="undefined"){for(var c=
[],d=0,e=b.files.length;d<e;d++)b.files[d].thumb&&c.push(b.files[d]);b.images=c;j[b.id].images=c}return b.images}function r(b){k[b]==""&&a.ee_filebrowser.endpoint_request("directory_contents",{directory:b},i)}function w(){h.dialog({width:968,height:610,resizable:false,position:["center","center"],modal:true,draggable:true,title:EE.filebrowser.window_title,autoOpen:false,zIndex:99999,open:function(){var b=a("#dir_choice").val();r(b)}});m="list";a("#dir_choice").change(function(){r(this.value);i(this.value,
0)});a.template("fileRow",a("<tbody />").append(a("#rowTmpl").remove().attr("id","")));a.template("noFilesRow",a("#noFilesRowTmpl").remove());a.template("pagination",a("#paginationTmpl").remove());a.template("thumb",a("#thumbTmpl").remove());a("#upload_form",h).submit(a.ee_filebrowser.upload_start);a("#file_chooser_body",h).addClass(m)}var s=0,k,o,h,p,q,t,j={},m;a.ee_filebrowser=function(){p=14;q=36;a.ee_filebrowser.endpoint_request("setup",function(b){k={};o={};h=a(b.manager).appendTo(document.body);
for(var c in b.directories){s||(s=c);k[c]=""}w();typeof a.ee_fileuploader!="undefined"&&a.ee_fileuploader()})};a.ee_filebrowser.endpoint_request=function(b,c,d){if(!d&&a.isFunction(c)){d=c;c={}}c=a.extend(c,{action:b});a.getJSON(EE.BASE+"&"+EE.filebrowser.endpoint_url+"&"+a.param(c),d)};a.ee_filebrowser.reload_directory=function(b){a.ee_filebrowser.endpoint_request("directory_contents",{directory:b},function(c){j[b]=c;a("#dir_choice").val()==b&&i(b)})};a.ee_filebrowser.add_trigger=function(b,c,d){if(!d&&
a.isFunction(c)){d=c;c="userfile"}a(b).click(function(){var e=this;a("#upload_file",h).attr("name",c);h.dialog("open");t=function(g){d.call(e,g,c)};return false})};a.ee_filebrowser.placeImage=function(b,c){a.ee_filebrowser.clean_up(k[b][c],"");return false};a.ee_filebrowser.clean_up=function(b,c){a("#page_0 .items").html(c);h.dialog("close");t(b)};a.ee_filebrowser.setPage=i})(jQuery);
