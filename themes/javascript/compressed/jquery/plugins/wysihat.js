/*  WysiHat - WYSIWYG JavaScript framework, version 0.2.1
 *  (c) 2008-2010 Joshua Peek
 *  JQ-WysiHat - jQuery port of WysiHat to run on jQuery
 *  (c) 2010 Scott Williams & Aaron Gustafson
 *
 *  WysiHat is freely distributable under the terms of an MIT-style license.
 *--------------------------------------------------------------------------*/

var WysiHat={name:"WysiHat",addButton:function(e,c){this._buttons[e]=c},inherit:function(e,c){function b(){var a;this.parent={};for(a in e)e.hasOwnProperty(a)&&(this.parent[a]=$.proxy(e[a],this))}var a,g;b.prototype=e;g=new b;for(a in c)g[a]=c[a];return g},_buttons:[]};
(function(e){var c=WysiHat.name,b=c+"-editor",a=b+":change",g=c+"-field:change",d=0;WysiHat.Editor={attach:function(f,h){function i(){f.val(WysiHat.Formatting.getApplicationMarkupFrom(j));l=null}function m(){j.html(WysiHat.Formatting.getBrowserMarkupFrom(f));n=null}var k=f.attr("id"),o=(k?k:c+d++)+"-editor",l=null,n=null,j=e("#"+o);k==""&&(k=o.replace("-editor","-field"),f.attr("id",k));if(j.length)return j.hasClass(b)||j.addClass(b),j;j=e('<div id="'+o+'" class="'+b+'" contentEditable="true" role="application"></div>').html(WysiHat.Formatting.getBrowserMarkupFrom(f)).data("field",
f);j.height(f.height());f.bind("keyup mouseup",function(){f.trigger(g)}).bind(g,function(){l&&clearTimeout(l);l=setTimeout(m,250)}).bind(g+":immediate",m).hide().before(j.bind("keyup mouseup",function(){j.trigger(a)}).bind(a,function(){n&&clearTimeout(n);n=setTimeout(i,250)}).bind(a+":immediate",i));e.extend(j,WysiHat.Commands);j.data("wysihat",j);j.selectionUtil=new WysiHat.SelectionUtil(j);j.data("selectionUtil",j.selectionUtil);j.eventCore=new WysiHat.EventCore(j);j.data("eventCore",j.eventCore);
j.toolbar=new WysiHat.Toolbar(j,h.buttons);j.data("toolbar",j.toolbar);return j}}})(jQuery);
WysiHat.Element=function(){function e(a){for(var d=arguments.length,b=!1;b==!1&&d-- >1;)b=a.is(arguments[d].join(","));return b}var c=["blockquote","details","fieldset","figure","td"],b=["article","aside","header","footer","nav","section"],a=["blockquote","details","dl","ol","table","ul"],g=["dd","dt","li","summary","td","th"],d=["address","caption","dd","div","dt","figcaption","figure","h1","h2","h3","h4","h5","h6","hgroup","hr","p","pre","summary","small"],f=["audio","canvas","embed","iframe","img",
"object","param","source","track","video"],h=["a","abbr","b","br","cite","code","del","dfn","em","i","ins","kbd","mark","span","q","samp","s","strong","sub","sup","time","u","var","wbr"],i=["b","code","del","em","i","ins","kbd","span","s","strong","u","font"],m=["address","blockquote","div","dd","dt","h1","h2","h3","h4","h5","h6","p","pre"],k=["button","datalist","fieldset","form","input","keygen","label","legend","optgroup","option","output","select","textarea"];return{isRoot:function(a){return e(a,
c)},isSection:function(a){return e(a,b)},isContainer:function(d){return e(d,a)},isSubContainer:function(a){return e(a,g)},isBlock:function(f){return e(f,c,b,a,g,d)},isHTML4Block:function(a){return e(a,m)},isContentElement:function(a){return e(a,g,d)},isMediaElement:function(a){return e(a,f)},isPhraseElement:function(a){return e(a,h)},isFormatter:function(a){return e(a,i)},isFormComponent:function(a){return e(a,k)},getRoots:function(){return c},getSections:function(){return b},getContainers:function(){return a},
getSubContainers:function(){return g},getBlocks:function(){return c.concat(b,a,g,d)},getHTML4Blocks:function(){return m},getContentElements:function(){return g.concat(d)},getMediaElements:function(){return f},getPhraseElements:function(){return h},getFormatters:function(){return i},getFormComponents:function(){return k}}}(jQuery);
(function(e,c){e(document).ready(function(){function b(a){var a=h||e(this),d=window.getSelection(),b=document.createRange();a.html()=="<p>\u200b</p>"&&(d.removeAllRanges(),b.selectNodeContents(a.find("p").get(0)),d.addRange(b),e.browser.mozilla&&a.find("p").eq(0).html(""))}var a=null,g=e(c),d,f,h;e("body").delegate("input,textarea,*[contenteditable],*[contenteditable=true]","keydown",function(){a&&clearTimeout(a);h=e(this);a=setTimeout(function(){var a=h.get(0),d,f;if(h.is('*[contenteditable=""],*[contenteditable=true]')){d=
h.html();if(d==""||d=="<br>"||d=="<br/>")d="<p>&#x200b;</p>",h.html(d),b(h);f="editor:change"}else d=h.val(),f="field:change";if(d&&a.previousValue!=d)h.trigger("WysiHat-"+f),a.previousValue=d},100)}).delegate("*[contenteditable],*[contenteditable=true]","focus",b);"onselectionchange"in c&&"selection"in c?g.bind("selectionchange",function(){var a=c.selection.createRange().parentElement();e(a).trigger("WysiHat-selection:change")}):(f=function(){var a=c.activeElement,b=a.tagName.toLowerCase();if(b==
"textarea"||b=="input")d=null;else{a=window.getSelection();if(a.rangeCount<1)return;if((a=a.getRangeAt(0))&&a.equalRange(d))return;d=a;for(a=a.commonAncestorContainer;a.nodeType==Node.TEXT_NODE;)a=a.parentNode}e(a).trigger("WysiHat-selection:change")},g.mouseup(f),g.keyup(f))})})(jQuery,document);
(function(e){var c,b;c=function(){for(var a={3:"enter",8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",27:"esc",32:"space",37:"left",38:"up",39:"right",40:"down",46:"delete",91:"mod",92:"mod",93:"mod",59:";",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63232:"up",63233:"down",63234:"left",63235:"right",63272:"delete"},b=0;b<10;b++)a[b+48]=String(b);for(b=65;b<=90;b++)a[b]=String.fromCharCode(b);return a}();b=function(){var a=/AppleWebKit/.test(navigator.userAgent)&&
/Mobile\/\w+/.test(navigator.userAgent)||/Mac/.test(navigator.platform)?"cmd":"ctrl";return{cut:a+"-x",copy:a+"-c",paste:a+"-v",undo:a+"-z",redo:a+"-shift-z",bold:a+"-b",italics:a+"-i",underline:a+"-u"}}();WysiHat.Events=function(){var a={};return{add:function(b,d){a[b]=d},has:function(b){return b in a},run:function(b,d,f){a[b](d,f)!==!1&&f()}}}();WysiHat.Events.add("paste",function(a,b,d){setTimeout(function(){WysiHat.Formatting.cleanup(a);d()},50);return!1});WysiHat.EventCore=function(a){this.$editor=
a;this.pasteStart=this.textStart=null;this.textDeleting=!1;this.undoStack=new WysiHat.UndoStack;this.selectionUtil=a.data("selectionUtil");this.events=WysiHat.Events;this._hijack_events()};WysiHat.EventCore.prototype={fire:function(a){var b=this,d,f;this._saveTextState(a);if(a=="undo"||a=="redo"){if(this.undoStack[a=="undo"?"hasUndo":"hasRedo"]())f=this.undoStack[a](this.$editor.html()),this.$editor.html(f[0]),this.selectionUtil.set(f[1])}else{d=this.getState();if(!this.events.has(a))return!0;f=function(){if(!this.hasRun)this.hasRun=
!0,b.textChange(d),b._saveTextState(a),b.$editor.focus()};this.events.run(a,d,e.proxy(f,f))}},textChange:function(a,b){b=b||this.getState();this.undoStack.push(a.html,b.html,a.selection,b.selection)},isKeyCombo:function(a,b){var d="",f="",f=a.indexOf("-")>-1;if(b.altGraphKey)return!1;b.metaKey&&(d+="cmd-");b.altKey&&(d+="alt-");b.ctrlKey&&(d+="ctrl-");b.shiftKey&&(d+="shift-");if(!f&&a.length>1)return d.replace(/-$/,"")==a;f=c[b.keyCode];return!f?!1:a.toLowerCase()==(d+f).toLowerCase()},isEvent:function(a,
c){var d=c.type;if(d==a)return!0;if(d.substr(0,3)!="key")return!1;d=b[a];return!d?!1:this.isKeyCombo(d,c)},getState:function(){return{html:this.$editor.html(),selection:this.selectionUtil.get()}},_saveTextState:function(a){if(a!="redo"&&this.textStart)this.textChange(this.textStart),this.textStart=null},_hijack_events:function(){this.$editor.on({"selectionchange focusin mouseup":e.proxy(this._rangeEvent,this),"keydown keyup keypress":e.proxy(this._keyEvent,this),"cut undo redo paste input contextmenu":e.proxy(this._menuEvent,
this)})},_keyComboEvent:function(a){var b=["undo","redo","paste"],d;if(a.type=="keydown")for(;d=b.shift();)if(this.isEvent(d,a)){if(d=="paste"){this.fire(d);break}a.preventDefault();this.fire(d);return!1}return!0},_keyEvent:function(a){if(a.type=="keypress")return!0;if(a.ctrlKey||a.altKey||a.metaKey)return this._keyComboEvent(a);if(a.type=="keydown"){if(c[a.keyCode]=="backspace"){if(this.textDeleting==!1)this.textDeleting=!0,this._saveTextState("backspace")}else if(this.textDeleting==!0)this.textDeleting=
!1,this._saveTextState("keypress");if(this.textStart==null)this.textStart=this.getState()}else if(a.type=="keyup")switch(c[a.keyCode]){case "up":case "down":case "left":case "right":this._saveTextState("keyup")}},_rangeEvent:function(a){this._saveTextState(a.type)},_menuEvent:function(a){for(var b=["undo","redo"],d;d=b.shift();)if(this.isEvent(d,a))return a.preventDefault(),this.fire(d),!1}};WysiHat.EventCore.constructor=WysiHat.EventCore;WysiHat.UndoStack=function(){this.max_depth=75;this.saved=
[];this.index=0};WysiHat.UndoStack.prototype={push:function(a,b,d,f){var c=[],i=this;if(c=e.isArray(a)?e.map(a,function(a,d){return i._diff(a,b[d])}):this._diff(a,b)){if(this.index<this.saved.length)this.saved=this.saved.slice(0,this.index),this.index=this.saved.length;this.index++;this.saved.push({changes:c,selection:[d,f]})}},undo:function(a){this.index--;for(var b=this.saved[this.index],d=b.changes,f=d.length,c=0;c<f;c++)change=d[c],a=a.substring(0,change[0])+change[1]+a.substring(change[0]+change[2].length);
return[a,b.selection[0]]},redo:function(a){for(var b=this.saved[this.index],d=b.changes,f=d.length-1;f>=0;f--)change=d[f],a=a.substring(0,change[0])+change[2]+a.substring(change[0]+change[1].length);this.index++;return[a,b.selection[1]]},hasUndo:function(){return this.index!=0},hasRedo:function(){return this.index!=this.saved.length},_diff:function(a,b){var d=a.length,f=b.length,c=0,e=0;if(a==b)return null;for(;c<d&&c<f;){if(a[c]!=b[c])break;c++}for(;e<d&&e<f;){if(a[d-e-1]!=b[f-e-1])break;e++}c==
Math.min(d,f)&&(c=0);e==Math.min(d,f)&&(e=0);if(c||e)a=a.substring(c,d-e),b=b.substring(c,f-e),d=a.length,f=b.length;return d!==f&&(e=d<f?b.indexOf(a):a.indexOf(b),e>-1)?d<f?[[c,"",b.substr(0,e)],[c+d,"",b.substr(e+d)]]:[[c,a.substr(0,e),""],[c+e+f,a.substr(e+f),""]]:[[c,a,b]]}};WysiHat.UndoStack.constructor=WysiHat.UndoStack;WysiHat.SelectionUtil=function(a){this.$editor=a;this.top=this.$editor.get(0)};WysiHat.SelectionUtil.prototype={get:function(a){var b=window.getSelection(),d=document.createRange();
a===void 0&&(a=b.getRangeAt(0));b=a.toString().replace(/\n/g,"").length;d.setStart(this.top,0);d.setEnd(a.startContainer,a.startOffset);a=d.toString().replace(/\n+/g,"").length;return[a,a+b]},set:function(a,b){e.isArray(a)&&(b=a[1],a=a[0]);var d=window.getSelection(),f=document.createRange(),c;c=this._getOffsetNode(this.top,a);f.setStart.apply(f,c);b===void 0?f.collapse(!0):(c=this._getOffsetNode(this.top,b),f.setEnd.apply(f,c));d.removeAllRanges();d.addRange(f)},toString:function(a){var b=window.getSelection();
a===void 0&&(a=b.getRangeAt(0));return a.toString()},_getOffsetNode:function(a,b){function d(a){if(a.nodeType==Node.TEXT_NODE||a.nodeType==Node.CDATA_SECTION_NODE)b>0&&(f=a,b-=a.nodeValue.replace(/\n/g,"").length);else for(var c=0,e=a.childNodes.length;b>0&&c<e;++c)d(a.childNodes[c])}var f=a,c=0;d(a);if(b==0){if(f.nodeType!=Node.TEXT_NODE)return[f,0];for(;f.nextSibling===null;)f=f.parentNode;f=f.nextSibling}c=f.nodeValue?f.nodeValue.length:0;return[f,c+b]}};WysiHat.SelectionUtil.constructor=WysiHat.SelectionUtil})(jQuery);
WysiHat.Commands=function(e,c,b){function a(){return p("b,strong")||document.queryCommandState("bold")}function g(){return p("u,ins")||document.queryCommandState("underline")}function d(){return p("i,em")||document.queryCommandState("italic")}function f(){return p("s,del")||document.queryCommandState("strikethrough")}function h(){return p("a[href]")}function i(){var a=b("<ol/>");m()?this.manipulateSelection(function(a){this.getRangeElements(a,"ol").each(function(){var a=b(this);a.children("li").each(function(){var a=
b(this);l(a,"p");a.find("ol,ul").each(function(){var a=b(this).parent();a.is("p")&&n.apply(a)})});n.apply(a)})}):this.manipulateSelection(function(a,d){var c=d.clone();this.getRangeElements(a,r).each(function(a){var d=b(this);d.parent().is("ul")?(l(d.parent(),"ol"),c=d.parent()):(a||d.replaceWith(c),d.appendTo(c))});c.children(":not(li)").each(function(){l(b(this),"li")})},a);b(c.activeElement).trigger(q)}function m(){return p("ol")||document.queryCommandState("insertOrderedList")}function k(){var a=
b("<ul/>");o()?this.manipulateSelection(function(a){this.getRangeElements(a,"ul").each(function(){var a=b(this);a.children("li").each(function(){var a=b(this);l(a,"p");a.find("ol,ul").each(function(){var a=b(this).parent();a.is("p")&&n.apply(a)})});n.apply(a)})}):this.manipulateSelection(function(a,d){var c=d.clone();this.getRangeElements(a,r).each(function(a){var d=b(this);d.parent().is("ol")?(l(d.parent(),"ul"),c=d.parent()):(a||d.replaceWith(c),d.appendTo(c))});c.children(":not(li)").each(function(){l(b(this),
"li")})},a);b(c.activeElement).trigger(q)}function o(){return p("ul")||document.queryCommandState("insertUnorderedList")}function l(a,d){if(!a.hasClass(s)){for(var c=a.get(0),f=b("<"+d+"/>").html(c.innerHTML),c=c.attributes,e=c.length||0;e--;)f.attr(c[e].name,c[e].value);a.replaceWith(f);return f}}function n(){var a=b(this);a.replaceWith(a.html());b(c.activeElement).trigger(q)}function j(){try{c.execCommand("styleWithCSS",0,!1),j=function(){c.execCommand("styleWithCSS",0,!1)}}catch(a){try{c.execCommand("useCSS",
0,!0),j=function(){c.execCommand("useCSS",0,!0)}}catch(b){try{c.execCommand("styleWithCSS",!1,!1),j=function(){c.execCommand("styleWithCSS",!1,!1)}}catch(d){}}}}function p(a){var d=WysiHat.Element.getPhraseElements(),c=!1,f=a.split(","),g=f.length,h=e.getSelection(),i=h.anchorNode,h=h.focusNode;if(i&&i.nodeType&&i.nodeType==3&&i.nodeValue=="")i=i.nextSibling;if(b.browser.mozilla){for(;g--;)if(b.inArray(f[g],d)!=-1){c=!0;break}if(c&&i.nodeType==1&&b.inArray(i.nodeName.toLowerCase(),d)==-1&&(g=i.firstChild)){if(g.nodeValue==
"")g=g.nextSibling;g.nodeType==1&&(i=g)}}if(!i)return!1;for(;i&&h&&i.nodeType!=1&&h.nodeType!=1;){if(i.nodeType!=1)i=i.parentNode;if(h.nodeType!=1)h=h.parentNode}return!(!b(i).closest(a).length&&!b(h).closest(a).length)}var s="WysiHat-editor",q=s+":change",t=["backColor","bold","createLink","fontName","fontSize","foreColor","hiliteColor","italic","removeFormat","strikethrough","subscript","superscript","underline","unlink","delete","formatBlock","forwardDelete","indent","insertHorizontalRule","insertHTML",
"insertImage","insertLineBreak","insertOrderedList","insertParagraph","insertText","insertUnorderedList","justifyCenter","justifyFull","justifyLeft","justifyRight","outdent","copy","cut","paste","selectAll","styleWithCSS","useCSS"],r=WysiHat.Element.getContentElements().join(",").replace(",div,",",div:not(."+s+"),");j();return{boldSelection:function(){this.execCommand("bold",!1,null)},isBold:a,italicizeSelection:function(){this.execCommand("italic",!1,null)},isItalic:d,underlineSelection:function(){this.execCommand("underline",
!1,null)},isUnderlined:g,strikethroughSelection:function(){this.execCommand("strikethrough",!1,null)},isStruckthrough:f,quoteSelection:function(){this.manipulateSelection(function(a,d){var c=d.clone(),f=this.getRangeElements(a,r),e=f.length-1,g=b();f.each(function(a){var d=b(this),f=!1;WysiHat.Element.isSubContainer(d)&&(f=!0);!a&&f&&a==e?(f=b("<p/>").html(d.html()),d.html("").append(f),g=g.add(f)):g=f?g.add(d.closest(WysiHat.Element.getContainers().join(","))):g.add(d);a==e&&g.wrapAll(c)})},b("<blockquote/>"))},
unquoteSelection:function(){this.manipulateSelection(function(a){this.getRangeElements(a,"blockquote > *").each(function(){var a=this,d=b(a),c=d.closest("blockquote"),f=c.clone().html(""),c=c.children(),e=c.length-1,g=b();d.unwrap("blockquote");e>0&&c.each(function(d){this!=a&&(g=g.add(this));if(d==e||this==a)g.wrapAll(f.clone()),g=b()});c=d.parent();WysiHat.Element.isSubContainer(c)&&c.children().length==1&&c.html(d.html())})})},toggleIndentation:function(){this.isIndented()?this.unquoteSelection():
this.quoteSelection()},isIndented:function(){return p("blockquote")},fontSelection:function(a){this.execCommand("fontname",!1,a)},fontSizeSelection:function(a){this.execCommand("fontsize",!1,a)},colorSelection:function(a){this.execCommand("forecolor",!1,a)},backgroundColorSelection:function(a){b.browser.mozilla?this.execCommand("hilitecolor",!1,a):this.execCommand("backcolor",!1,a)},alignSelection:function(a){this.execCommand("justify"+a)},alignSelected:function(){var a=e.getSelection().getNode();
return b(a).css("textAlign")},linkSelection:function(a){this.execCommand("createLink",!1,a)},unlinkSelection:function(){this.manipulateSelection(function(a){this.getRangeElements(a,"[href]").each(this.clearElement)})},isLinked:h,toggleOrderedList:i,insertOrderedList:function(){i()},isOrderedList:m,toggleUnorderedList:k,insertUnorderedList:function(){k()},isUnorderedList:o,insertImage:function(a){this.execCommand("insertImage",!1,a)},insertHTML:function(a){if(b.browser.msie){var d=c.selection.createRange();
d.pasteHTML(a);d.collapse(!1);d.select();b(c.activeElement).trigger(q)}else this.execCommand("insertHTML",!1,a)},wrapHTML:function(){var a=e.getSelection(),d=a.getRangeAt(0),f=a.getNode(),g=arguments.length;d.collapsed&&(d=c.createRange(),d.selectNodeContents(f),a.removeAllRanges(),a.addRange(d));for(d=a.getRangeAt(0);g--;)a=b("<"+arguments[g]+"/>"),d.surroundContents(a.get(0));b(c.activeElement).trigger(q)},changeContentBlock:function(a){for(var d=e.getSelection(),f=this,g=b(f),h=d.rangeCount,i=
[],m;h--;)m=d.getRangeAt(h),i.push(m),this.getRangeElements(m,r).each(function(){f.replaceElement(b(this),a)}).data("WysiHat-replaced",!0);g.children(a).removeData("WysiHat-replaced");b(c.activeElement).trigger(q);this.restoreRanges(i)},unformatContentBlock:function(){this.changeContentBlock("p")},replaceElement:l,deleteElement:n,stripFormattingElements:function(){function a(d,c){var e=b(c);e.children().each(a);f(e)&&n.apply(e)}for(var d=e.getSelection(),f=WysiHat.Element.isFormatter,g=d.rangeCount,
h=[],i;g--;)i=d.getRangeAt(g),h.push(i),this.getRangeElements(i,r).each(a);b(c.activeElement).trigger(q);this.restoreRanges(h)},execCommand:function(a,d,f){j();try{c.execCommand(a,d,f)}catch(e){return null}b(c.activeElement).trigger(q)},noSpans:j,queryCommandState:function(a){var d=this.queryCommands[a];if(d)return d();try{return c.queryCommandState(a)}catch(b){return null}},getSelectedStyles:function(){var a=window.getSelection(),a=b(a.getNode()),d={},c;for(c in this.styleSelectors)d[c]=a.css(this.styleSelectors[c]);
return d},toggleHTML:function(a){var d=!1,c=b(this),a=b(a.target),f=a.text(),e=a.closest("button,[role=button]"),g=c.data("field"),h=e.siblings();e.data("toggle-text")==void 0&&e.data("toggle-text","View Content");this.toggleHTML=function(){d?(e.find("b").text(f),h.show(),g.trigger("WysiHat-field:change:immediate").hide(),c.show()):(e.find("b").text(e.data("toggle-text")),h.hide(),c.trigger("WysiHat-editor:change:immediate").hide(),g.show());d=!d};this.toggleHTML()},isValidCommand:function(a){return b.inArray(a,
t)>-1},manipulateSelection:function(){for(var a=e.getSelection(),d=a.rangeCount,f=[],g=arguments,h=g[0],i;d--;)i=a.getRangeAt(d),f.push(i),g[0]=i,h.apply(this,g);b(c.activeElement).trigger(q);this.restoreRanges(f)},getRangeElements:function(a,d){var c=b(a.startContainer).closest(d),f=b(a.endContainer).closest(d),e=b("nullset");c.parents(".WysiHat-editor").length&&f.parents(".WysiHat-editor").length&&(e=c,c.filter(f).length||(e=c.nextAll().filter(f).length?c.nextUntil(f).andSelf().add(f):c.prevUntil(f).andSelf().add(f)));
return e},getRanges:function(){for(var a=e.getSelection(),d=a.rangeCount,b=[],c;d--;)c=a.getRangeAt(d),b.push(c);return b},restoreRanges:function(a){var d=e.getSelection(),b=a.length;for(d.removeAllRanges();b--;)d.addRange(a[b])},selectionIsWithin:p,getBlockElements:function(){return r},queryCommands:{bold:a,italic:d,underline:g,strikethrough:f,createLink:h,orderedlist:m,unorderedlist:o},styleSelectors:{fontname:"fontFamily",fontsize:"fontSize",forecolor:"color",hilitecolor:"backgroundColor",backcolor:"backgroundColor"}}}(window,
document,jQuery);
(function(e){WysiHat.Formatting={cleanup:function(c){var b=WysiHat.Commands.replaceElement;c.find("span").each(function(){var a=e(this);a.hasClass("Apple-style-span")&&a.removeClass("Apple-style-span");a.css("font-weight")=="bold"&&a.css("font-style")=="italic"?(a.removeAttr("style").wrap("<strong>"),b(a,"em")):a.css("font-weight")=="bold"?b(a.removeAttr("style"),"strong"):a.css("font-style")=="italic"&&b(a.removeAttr("style"),"em")}).end().children("div").each(function(){this.attributes.length||b(e(this),
"p")}).end().find("b").each(function(){b(e(this),"strong")}).end().find("i").each(function(){b(e(this),"em")}).end().find("strike").each(function(){b(e(this),"del")}).end().find("u").each(function(){b(e(this),"ins")}).end().find("p:empty").remove()},format:function(c){var b=RegExp("(<(?:ul|ol)>|</(?:"+WysiHat.Element.getBlocks().join("|")+")>)[\r\n]*","g"),b=c.html().replace("<p>&nbsp;</p>","").replace(/<br\/?><\/p>/,"</p>").replace(b,"$1\n").replace(/\n+/,"\n").replace(/<p>\n+<\/p>/,"");c.html(b)},
getBrowserMarkupFrom:function(c){c=e("<div>"+c.val().replace(/\n/,"")+"</div>");this.cleanup(c);(c.html()==""||c.html()=="<br>"||c.html()=="<br/>")&&c.html("<p>&#x200b;</p>");return c.html()},getApplicationMarkupFrom:function(c){c=c.clone();c=e("<div/>").html(c.html());(c.html()==""||c.html()=="<br>"||c.html()=="<br/>")&&c.html("<p>&#x200b;</p>");this.cleanup(c);this.format(c);return c.html().replace(/<\/?[A-Z]+/g,function(b){return b.toLowerCase()})}}})(jQuery);
(function(e){var c={init:function(b,a){this.name=b;this.$editor=a;return this},setElement:function(b){this.$element=e(b);return this},getHandler:function(){if(this.handler)return e.proxy(this,"handler");var b=this;return WysiHat.Commands.isValidCommand(this.name)?WysiHat.Commands[this.name+"Selection"]?function(){return b.$editor[b.name+"Selection"]()}:function(){return b.$editor.execCommand(b.name)}:e.noop},getStateHandler:function(){if(this.query)return e.proxy(this,"query");else if(WysiHat.Commands.isValidCommand(this.name)){var b=
this;return function(a){return a.queryCommandState(b.name)}}return e.noop},setOn:function(){this.$element.addClass("selected").attr("aria-pressed","true").find("b").text(this["toggle-text"]?this["toggle-text"]:this.label);return this},setOff:function(){this.$element.removeClass("selected").attr("aria-pressed","false").find("b").text(this.label);return this}};WysiHat.Toolbar=function(b,a){this.$editor=b;this.$toolbar=e('<div class="'+WysiHat.name+'-editor-toolbar" role="presentation"></div>');b.before(this.$toolbar);
var c=a.length,d;for(d=0;d<c;d++)this.addButton(a[d])};WysiHat.Toolbar.prototype={addButton:function(b){var a=WysiHat.inherit(c,WysiHat._buttons[b]).init(b,this.$editor);a.Selection=this.$editor.data("selectionUtil");a.setElement(this.createButtonElement(a));WysiHat.Events.add(b,a.getHandler());this.observeButtonClick(a);this.observeStateChanges(a)},createButtonElement:function(b){var a;if(b.type&&b.type=="select"){var c=b.options,d=c.length,f=0;for(a=e('<select class="button picker"/>');f<d;f++)a.append('<option value="'+
c[f][0]+'">'+c[f][1]+"</option>")}else a=e('<button aria-pressed="false" tabindex="-1"></button>'),a.append("<b>"+b.label+"</b>").addClass("button "+b.name).hover(function(){this.title=e(this).find("b").text()},function(){e(this).removeAttr("title")});a.appendTo(this.$toolbar);b.cssClass&&a.addClass(b.cssClass);b.title&&a.attr("title",b.title);a.data("text",b.label);b["toggle-text"]&&a.data("toggle-text",b["toggle-text"]);return a},observeButtonClick:function(b){b.$element.bind(b.type&&b.type=="select"?
"change":"click",function(){var a=b.$editor;a.is(":focus")||a.focus();a.eventCore.fire(b.name);return!1})},observeStateChanges:function(b){var a=this,c=b.getStateHandler(),d;a.$editor.bind("WysiHat-selection:change",function(){var f=c(b.$editor,b.$element);f!=d&&(d=f,a.updateButtonState(b,f))})},updateButtonState:function(b,a){a?b.setOn():b.setOff()}};WysiHat.Toolbar.constructor=WysiHat.Toolbar})(jQuery);
jQuery.fn.wysihat=function(e){var c=this.data("wysihat");return c?jQuery.inArray(e,["selectionUtil","eventCore","toolbar"])!=-1?c[e]:c:this.each(function(){WysiHat.Editor.attach(jQuery(this),e)})};
window.getSelection||function(e){var c={isDataNode:function(b){try{return b&&b.nodeValue!==null&&b.data!==null}catch(a){return!1}},isAncestorOf:function(b,a){return!b?!1:!c.isDataNode(b)&&(a.parentNode==b||b.contains(c.isDataNode(a)?a.parentNode:a))},isAncestorOrSelf:function(b,a){return b==a||c.isAncestorOf(b,a)},findClosestAncestor:function(b,a){if(c.isAncestorOf(b,a))for(;a&&a.parentNode!=b;)a=a.parentNode;return a},getNodeLength:function(b){return c.isDataNode(b)?b.length:b.childNodes.length},
splitDataNode:function(b,a){if(!c.isDataNode(b))return!1;var e=b.cloneNode(!1);b.deleteData(a,b.length);e.deleteData(0,a);b.parentNode.insertBefore(e,b.nextSibling)}};window.Range=function(){function b(a){this._document=a;this.startContainer=this.endContainer=a.body;this.endOffset=c.getNodeLength(a.body)}function a(a){for(var b=0;a=a.previousSibling;b++);return b}function e(a){this.range=a;if(!a.collapsed){var b=a.commonAncestorContainer;this._next=a.startContainer==b&&!c.isDataNode(a.startContainer)?
a.startContainer.childNodes[a.startOffset]:c.findClosestAncestor(b,a.startContainer);this._end=a.endContainer==b&&!c.isDataNode(a.endContainer)?a.endContainer.childNodes[a.endOffset]:c.findClosestAncestor(b,a.endContainer).nextSibling}}b.prototype={START_TO_START:0,START_TO_END:1,END_TO_END:2,END_TO_START:3,startContainer:null,startOffset:0,endContainer:null,endOffset:0,commonAncestorContainer:null,collapsed:!1,_document:null,_toTextRange:function(){function a(b,d,f){var e=d[f?"startContainer":"endContainer"],
g=d[f?"startOffset":"endOffset"],l=0;c.isDataNode(e);c.isDataNode(e);d._document.createElement("a");d=d._document.body.createTextRange();if(e.nodeType==3||e.nodeType==4)l=g;b.setEndPoint(f?"StartToStart":"EndToStart",d);b[f?"moveStart":"moveEnd"]("character",l)}var b=this._document.body.createTextRange();a(b,this,!0);a(b,this,!1);return b},_refreshProperties:function(){this.collapsed=this.startContainer==this.endContainer&&this.startOffset==this.endOffset;for(var a=this.startContainer;a&&a!=this.endContainer&&
!c.isAncestorOf(a,this.endContainer);)a=a.parentNode;this.commonAncestorContainer=a},setStart:function(a,b){this.startContainer=a;this.startOffset=b;this._refreshProperties()},setEnd:function(a,b){this.endContainer=a;this.endOffset=b;this._refreshProperties()},setStartBefore:function(b){this.setStart(b.parentNode,a(b))},setStartAfter:function(b){this.setStart(b.parentNode,a(b)+1)},setEndBefore:function(b){this.setEnd(b.parentNode,a(b))},setEndAfter:function(b){this.setEnd(b.parentNode,a(b)+1)},selectNode:function(a){this.setStartBefore(a);
this.setEndAfter(a)},selectNodeContents:function(a){this.setStart(a,0);this.setEnd(a,c.getNodeLength(a))},collapse:function(a){a?this.setEnd(this.startContainer,this.startOffset):this.setStart(this.endContainer,this.endOffset)},cloneContents:function(){return function f(a){for(var b,c=document.createDocumentFragment();b=a.next();)b=b.cloneNode(!a.hasPartialSubtree()),a.hasPartialSubtree()&&b.appendChild(f(a.getSubtreeIterator())),c.appendChild(b);return c}(new e(this))},extractContents:function(){var a=
this.cloneRange();this.startContainer!=this.commonAncestorContainer&&this.setStartAfter(c.findClosestAncestor(this.commonAncestorContainer,this.startContainer));this.collapse(!0);return function h(a){for(var b,d=document.createDocumentFragment();b=a.next();)a.hasPartialSubtree()?b=b.cloneNode(!1):a.remove(),a.hasPartialSubtree()&&b.appendChild(h(a.getSubtreeIterator())),d.appendChild(b);return d}(new e(a))},deleteContents:function(){var a=this.cloneRange();this.startContainer!=this.commonAncestorContainer&&
this.setStartAfter(c.findClosestAncestor(this.commonAncestorContainer,this.startContainer));this.collapse(!0);(function h(a){for(;a.next();)a.hasPartialSubtree()?h(a.getSubtreeIterator()):a.remove()})(new e(a))},insertNode:function(a){if(c.isDataNode(this.startContainer))c.splitDataNode(this.startContainer,this.startOffset),this.startContainer.parentNode.insertBefore(a,this.startContainer.nextSibling);else{var b=this.startContainer.childNodes[this.startOffset];b?this.startContainer.insertBefore(a,
b):this.startContainer.appendChild(a)}this.setStart(this.startContainer,this.startOffset)},surroundContents:function(a){var b=this.extractContents();this.insertNode(a);a.appendChild(b);this.selectNode(a)},compareBoundaryPoints:function(a,b){var c,e,g,k;switch(a){case this.START_TO_START:case this.START_TO_END:c=this.startContainer;e=this.startOffset;break;case this.END_TO_END:case this.END_TO_START:c=this.endContainer,e=this.endOffset}switch(a){case this.START_TO_START:case this.END_TO_START:g=b.startContainer;
k=b.startOffset;break;case this.START_TO_END:case this.END_TO_END:g=b.endContainer,k=b.endOffset}return c.sourceIndex<g.sourceIndex?-1:c.sourceIndex==g.sourceIndex?e<k?-1:e==k?0:1:1},cloneRange:function(){var a=new b(this._document);a.setStart(this.startContainer,this.startOffset);a.setEnd(this.endContainer,this.endOffset);return a},toString:function(){return this._toTextRange().text},createContextualFragment:function(a){var b=(c.isDataNode(this.startContainer)?this.startContainer.parentNode:this.startContainer).cloneNode(!1),
e=this._document.createDocumentFragment();for(b.innerHTML=a;b.firstChild;)e.appendChild(b.firstChild);return e}};e.prototype={range:null,_current:null,_next:null,_end:null,hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next;this._next=this._current&&this._current.nextSibling!=this._end?this._current.nextSibling:null;c.isDataNode(this._current)&&(this.range.endContainer==this._current&&(a=a.cloneNode(!0)).deleteData(this.range.endOffset,a.length-this.range.endOffset),
this.range.startContainer==this._current&&(a=a.cloneNode(!0)).deleteData(0,this.range.startOffset));return a},remove:function(){if(c.isDataNode(this._current)&&(this.range.startContainer==this._current||this.range.endContainer==this._current)){var a=this.range.startContainer==this._current?this.range.startOffset:0;this._current.deleteData(a,(this.range.endContainer==this._current?this.range.endOffset:this._current.length)-a)}else this._current.parentNode.removeChild(this._current)},hasPartialSubtree:function(){return!c.isDataNode(this._current)&&
(c.isAncestorOrSelf(this._current,this.range.startContainer)||c.isAncestorOrSelf(this._current,this.range.endContainer))},getSubtreeIterator:function(){var a=new b(this.range._document);a.selectNodeContents(this._current);c.isAncestorOrSelf(this._current,this.range.startContainer)&&a.setStart(this.range.startContainer,this.range.startOffset);c.isAncestorOrSelf(this._current,this.range.endContainer)&&a.setEnd(this.range.endContainer,this.range.endOffset);return new e(a)}};return b}();window.Range._fromTextRange=
function(b,a){function c(b,d,e){var g=a.createElement("a"),k=d.duplicate(),o;k.collapse(e);o=k.parentElement();do o.insertBefore(g,g.previousSibling),k.moveToElementText(g);while(g.previousSibling&&k.compareEndPoints(e?"StartToStart":"StartToEnd",d)>0);if(g.nextSibling&&k.compareEndPoints(e?"StartToStart":"StartToEnd",d)==-1)k.setEndPoint(e?"EndToStart":"EndToEnd",d),b[e?"setStart":"setEnd"](g.nextSibling,k.text.length);else b[e?"setStartBefore":"setEndBefore"](g);g.parentNode.removeChild(g)}var d=
new Range(a);c(d,b,!0);c(d,b,!1);return d};document.createRange=function(){return new Range(document)};window.Selection=function(){function b(a){this._document=a;var b=this;a.attachEvent("onselectionchange",function(){b._selectionChangeHandler()});setTimeout(function(){b._selectionChangeHandler()},10)}b.prototype={rangeCount:0,_document:null,anchorNode:null,focusNode:null,_selectionChangeHandler:function(){var a=this._document.selection.createRange(),b=a.text.split(/\r|\n/),c=e(a.parentElement()),
f,h;b.length>1?(f=RegExp(b[0]+"$"),h=RegExp("^"+b[b.length-1]),c.children().each(function(){if(e(this).text().match(f))this.anchorNode=this;if(e(this).text().match(h))this.focusNode=this})):this.focusNode=this.anchorNode=c.get(0);this.rangeCount=this._selectionExists(a)?1:0},_selectionExists:function(a){return a.parentElement().isContentEditable||a.compareEndPoints("StartToEnd",a)!=0},addRange:function(a){var b=this._document.selection.createRange(),a=a._toTextRange();if(this._selectionExists(b))a.compareEndPoints("StartToStart",
b)==-1?a.compareEndPoints("StartToEnd",b)>-1&&a.compareEndPoints("EndToEnd",b)==-1&&b.setEndPoint("StartToStart",a):a.compareEndPoints("EndToStart",b)<1&&a.compareEndPoints("EndToEnd",b)>-1&&b.setEndPoint("EndToEnd",a),b.select();else try{a.select()}catch(c){}},removeAllRanges:function(){this._document.selection.empty()},getRangeAt:function(){var a=this._document.selection.createRange();return this._selectionExists(a)?Range._fromTextRange(a,this._document):null},toString:function(){return this._document.selection.createRange().text},
isCollapsed:function(){return document.createRange().collapsed},deleteFromDocument:function(){this._document.selection.createRange().pasteHTML("")}};return b}();window.getSelection=function(){var b=new Selection(document);return function(){return b}}()}(jQuery);
typeof Node=="undefined"&&function(){window.Node=new function(){return{ATTRIBUTE_NODE:2,CDATA_SECTION_NODE:4,COMMENT_NODE:8,DOCUMENT_FRAGMENT_NODE:11,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,ELEMENT_NODE:1,ENTITY_NODE:6,ENTITY_REFERENCE_NODE:5,NOTATION_NODE:12,PROCESSING_INSTRUCTION_NODE:7,TEXT_NODE:3}}}();
jQuery.extend(Range.prototype,{beforeRange:function(e){return!e||!e.compareBoundaryPoints?!1:this.compareBoundaryPoints(this.START_TO_START,e)==-1&&this.compareBoundaryPoints(this.START_TO_END,e)==-1&&this.compareBoundaryPoints(this.END_TO_END,e)==-1&&this.compareBoundaryPoints(this.END_TO_START,e)==-1},afterRange:function(e){return!e||!e.compareBoundaryPoints?!1:this.compareBoundaryPoints(this.START_TO_START,e)==1&&this.compareBoundaryPoints(this.START_TO_END,e)==1&&this.compareBoundaryPoints(this.END_TO_END,
e)==1&&this.compareBoundaryPoints(this.END_TO_START,e)==1},betweenRange:function(e){return!e||!e.compareBoundaryPoints?!1:!(this.beforeRange(e)||this.afterRange(e))},equalRange:function(e){return!e||!e.compareBoundaryPoints?!1:this.collapsed&&e.collapsed?this.compareBoundaryPoints(this.START_TO_START,e)==0:this.compareBoundaryPoints(this.START_TO_START,e)==0&&this.compareBoundaryPoints(this.START_TO_END,e)==1&&this.compareBoundaryPoints(this.END_TO_END,e)==0&&this.compareBoundaryPoints(this.END_TO_START,
e)==-1},getNode:function(){for(var e=this.commonAncestorContainer,c=this,b;e.nodeType==Node.TEXT_NODE;)e=e.parentNode;jQuery(e).children().each(function(){var a=document.createRange();a.selectNodeContents(this);b=c.betweenRange(a)});return $(b||e).get(0)}});if(typeof Selection=="undefined"){var Selection={};Selection.prototype=window.getSelection().__proto__}
(function(e,c){var b,a,g,d;c.browser.msie?(b=function(){var a=this._document.selection.createRange();return c(a.parentElement())},a=function(a){var b=this._document.body.createTextRange();b.moveToElementText(a);b.select()},g=function(){var a=c("#WysiHat-bookmark"),b=c("<div/>"),d=this._document.selection.createRange();a.length>0&&a.remove();c('<span id="WysiHat-bookmark">&nbsp;</span>').appendTo(b);d.collapse(!0);d.pasteHTML(b.html())},d=function(){var a=c("#WysiHat-bookmark"),b=this._document.selection.createRange();
a.length>0&&a.remove();b.moveToElementText(a.get(0));b.collapse(!0);b.select();a.remove()}):(b=function(){return this.rangeCount>0?this.getRangeAt(0).getNode():null},a=function(a){var b=e.createRange();b.selectNode(a[0]);this.removeAllRanges();this.addRange(b)},g=function(){var a=c("#WysiHat-bookmark");a.length>0&&a.remove();a=c('<span id="WysiHat-bookmark">&nbsp;</span>');this.getRangeAt(0).insertNode(a.get(0))},d=function(){var a=c("#WysiHat-bookmark"),b=e.createRange();a.length>0&&a.remove();b.setStartBefore(a.get(0));
this.removeAllRanges();this.addRange(b);a.remove()});c.extend(Selection.prototype,{getNode:b,selectNode:a,setBookmark:g,moveToBookmark:d})})(document,jQuery);
