/*  WysiHat - WYSIWYG JavaScript framework, version 0.2.1
 *  (c) 2008-2010 Joshua Peek
 *  JQ-WysiHat - jQuery port of WysiHat to run on jQuery
 *  (c) 2010 Scott Williams & Aaron Gustafson
 *
 *  WysiHat is freely distributable under the terms of an MIT-style license.
 *--------------------------------------------------------------------------*/

(function(i,e,l){var g=window.WysiHat={name:"WysiHat",addButton:function(a,b){this._buttons[a]=b},attach:function(a,b){return new g.Editor(e(a),b)},inherit:function(a,b){function c(){var b;this.parent={};for(b in a)a.hasOwnProperty(b)&&(this.parent[b]=e.proxy(a[b],this))}var d,f;c.prototype=a;f=new c;for(d in b)f[d]=b[d];return f},_buttons:[]};g.Editor=function(a,b){this.$field=a;this.$editor=this.create();a.hide().before(this.$editor);this.Element=g.Element;this.Commands=g.Commands;this.Formatting=
g.Formatting;this.init(b)};g.Editor.prototype={_empty:"<p>"+String.fromCharCode(8203)+"</p>",create:function(){return e("<div/>",{"class":g.name+"-editor",data:{wysihat:this,field:this.$field},role:"application",contentEditable:"true",height:this.$field.height(),html:g.Formatting.getBrowserMarkupFrom(this.$field)})},init:function(a){var b=this.$editor;this.Undo=new g.Undo;this.Selection=new g.Selection(b);this.Event=new g.Event(this);this.Toolbar=new g.Toolbar(b,a.buttons);this.$field.change(e.proxy(this,
"updateEditor"));b.closest("form").submit(function(){b.is(":visible")&&this.updateField()})},updateField:function(){this.$field.val(g.Formatting.getApplicationMarkupFrom(this.$editor))},updateEditor:function(){this.$editor.html(g.Formatting.getBrowserMarkupFrom(this.$field));this.selectEmptyParagraph()},selectEmptyParagraph:function(){var a=this.$editor,b=a.html(),c=window.getSelection();if(b==""||b=="<br>"||b=="<br/>"||b=="<p></p>"||b=="<p>\000</p>")a.html(this._empty),b=i.createRange(),c.removeAllRanges(),
b.selectNodeContents(a.find("p").get(0)),e.browser.mozilla&&a.find("p").eq(0).html(""),c.addRange(b)}};g.Editor.constructor=g.Editor;g.Element=function(){function a(a){for(var b=arguments.length,c=!1;c==!1&&b-- >1;)c=a.is(arguments[b].join(","));return c}var b=["blockquote","details","fieldset","figure","td"],c=["article","aside","header","footer","nav","section"],d=["blockquote","details","dl","ol","table","ul"],f=["dd","dt","li","summary","td","th"],h=["address","caption","dd","div","dt","figcaption",
"figure","h1","h2","h3","h4","h5","h6","hgroup","hr","p","pre","summary","small"],e=["audio","canvas","embed","iframe","img","object","param","source","track","video"],g=["a","abbr","b","br","cite","code","del","dfn","em","i","ins","kbd","mark","span","q","samp","s","strong","sub","sup","time","u","var","wbr"],k=["b","code","del","em","i","ins","kbd","span","s","strong","u","font"],i=["address","blockquote","div","dd","dt","h1","h2","h3","h4","h5","h6","p","pre"],p=["button","datalist","fieldset",
"form","input","keygen","label","legend","optgroup","option","output","select","textarea"];return{isRoot:function(c){return a(c,b)},isSection:function(b){return a(b,c)},isContainer:function(b){return a(b,d)},isSubContainer:function(b){return a(b,f)},isBlock:function(e){return a(e,b,c,d,f,h)},isHTML4Block:function(b){return a(b,i)},isContentElement:function(b){return a(b,f,h)},isMediaElement:function(b){return a(b,e)},isPhraseElement:function(b){return a(b,g)},isFormatter:function(b){return a(b,k)},
isFormComponent:function(b){return a(b,p)},getRoots:function(){return b},getSections:function(){return c},getContainers:function(){return d},getSubContainers:function(){return f},getBlocks:function(){return b.concat(c,d,f,h)},getHTML4Blocks:function(){return i},getContentElements:function(){return f.concat(h)},getMediaElements:function(){return e},getPhraseElements:function(){return g},getFormatters:function(){return k},getFormComponents:function(){return p}}}();e(i).ready(function(){var a=e(i),b,
c;if("onselectionchange"in i&&"selection"in i)a.on("selectionchange",function(){var a=i.selection.createRange().parentElement();e(a).trigger("WysiHat-selection:change")});else c=function(){var a=i.activeElement,c=a.tagName.toLowerCase();if(c=="textarea"||c=="input")b=null;else{a=window.getSelection();if(a.rangeCount<1)return;if((a=a.getRangeAt(0))&&a.equalRange(b))return;b=a;for(a=a.commonAncestorContainer;a.nodeType==Node.TEXT_NODE;)a=a.parentNode}e(a).trigger("WysiHat-selection:change")},a.mouseup(c),
a.keyup(c)});g.Paster=function(){var a=e('<div id="paster" contentEditable="true"/>').css({width:"100%",height:10,position:"absolute",left:-9999});return{getHandler:function(b){return function(c,d){var f=b.Commands.getRanges(),h=f[0].startContainer,j=0;a.html("").css("top",i.body.scrollTop);a.appendTo(i.body);a.focus();setTimeout(function q(){if(!a.html()&&(j+=50,j<200)){setTimeout(q,50);return}var c=e(h).closest(g.Element.getBlocks().join(",")),k=b.$editor.html();c.length?b.Formatting.cleanupPaste(a,
c.get(0).tagName):b.Formatting.cleanupPaste(a);b.$editor.focus();b.Commands.restoreRanges(f);k==""||k=="<br>"||k=="<br/>"||k=="<p></p>"||k=="<p>\000</p>"||k==b._empty?b.$editor.html(a.html()):b.Commands.insertHTML(a.html());a=a.remove();d()},50);return!1}}}}();var m,n;m=function(){for(var a={3:"enter",8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",27:"esc",32:"space",37:"left",38:"up",39:"right",40:"down",46:"delete",91:"mod",92:"mod",93:"mod",59:";",186:";",187:"=",188:",",189:"-",
190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63232:"up",63233:"down",63234:"left",63235:"right",63272:"delete"},b=0;b<10;b++)a[b+48]=String(b);for(b=65;b<=90;b++)a[b]=String.fromCharCode(b);return a}();n=function(){var a=/AppleWebKit/.test(navigator.userAgent)&&/Mobile\/\w+/.test(navigator.userAgent)||/Mac/.test(navigator.platform)?"cmd":"ctrl";return{cut:a+"-x",copy:a+"-c",paste:a+"-v",undo:a+"-z",redo:a+"-shift-z",bold:a+"-b",italics:a+"-i",underline:a+"-u"}}();g.Event=function(a){this.Editor=
a;this.$editor=a.$editor;this.eventHandlers=[];this.pasteStart=this.textStart=null;this.textDeleting=!1;this.Undo=a.Undo;this.Selection=a.Selection;this._hijack_events();this.add("paste",g.Paster.getHandler(a))};g.Event.prototype={add:function(a,b){this.eventHandlers[a]=b},has:function(a){return a in this.eventHandlers},run:function(a,b,c){this.eventHandlers[a](b,c)!==!1&&c()},fire:function(a){var b=this,c,d;this._saveTextState(a);if(a=="undo"||a=="redo"){if(this.Undo[a=="undo"?"hasUndo":"hasRedo"]())d=
this.Undo[a](this.$editor.html()),this.$editor.html(d[0]),this.Selection.set(d[1])}else{if(!this.has(a))return!0;c=this.getState();d=function(){if(!this.hasRun)this.hasRun=!0,b.textChange(c),b._saveTextState(a),b.$editor.focus()};this.run(a,c,e.proxy(d,d))}},textChange:function(a,b){b=b||this.getState();this.Editor.updateField();this.Editor.selectEmptyParagraph();this.Undo.push(a.html,b.html,a.selection,b.selection)},isKeyCombo:function(a,b){var c="",d="",d=a.indexOf("-")>-1;if(b.altGraphKey)return!1;
b.metaKey&&(c+="cmd-");b.altKey&&(c+="alt-");b.ctrlKey&&(c+="ctrl-");b.shiftKey&&(c+="shift-");if(!d&&a.length>1)return c.replace(/-$/,"")==a;d=m[b.keyCode];return!d?!1:a.toLowerCase()==(c+d).toLowerCase()},isEvent:function(a,b){var c=b.type;if(c==a)return!0;if(c.substr(0,3)!="key")return!1;c=n[a];return!c?!1:this.isKeyCombo(c,b)},getState:function(){return{html:this.$editor.html(),selection:this.Selection.get()}},_saveTextState:function(a){if(a!="redo"&&this.textStart)this.textChange(this.textStart),
this.textStart=null},_hijack_events:function(){this.$editor.on({"selectionchange focusin mousedown":e.proxy(this._rangeEvent,this),"keydown keyup keypress":e.proxy(this._keyEvent,this),"cut undo redo paste input contextmenu":e.proxy(this._menuEvent,this)})},_keyComboEvent:function(a){var b=["undo","redo","paste"],c;if(a.type=="keydown")for(;c=b.shift();)if(this.isEvent(c,a)){if(c=="paste"){this.fire(c);break}a.preventDefault();this.fire(c);return!1}return!0},_keyEvent:function(a){if(a.type=="keypress")return!0;
if(a.ctrlKey||a.altKey||a.metaKey)return this._keyComboEvent(a);if(a.type=="keydown"){if(m[a.keyCode]=="backspace"){if(this.textDeleting==!1)this.textDeleting=!0,this._saveTextState("backspace")}else if(this.textDeleting==!0)this.textDeleting=!1,this._saveTextState("keypress");if(this.textStart==null)this.textStart=this.getState()}else if(a.type=="keyup")switch(m[a.keyCode]){case "up":case "down":case "left":case "right":this._saveTextState("keyup")}},_rangeEvent:function(a){this._saveTextState(a.type)},
_menuEvent:function(a){for(var b=["undo","redo","paste"],c;c=b.shift();)this.isEvent(c,a)&&(c!="paste"&&a.preventDefault(),this.fire(c))}};g.Event.constructor=g.Event;g.Undo=function(){this.max_depth=75;this.saved=[];this.index=0};g.Undo.prototype={push:function(a,b,c,d){var f=[],h=this;if(f=e.isArray(a)?e.map(a,function(a,c){return h._diff(a,b[c])}):this._diff(a,b)){if(this.index<this.saved.length)this.saved=this.saved.slice(0,this.index),this.index=this.saved.length;if(this.saved.length>this.max_depth)this.saved=
this.saved.slice(this.saved.length-this.max_depth),this.index=this.saved.length;this.index++;this.saved.push({changes:f,selection:[c,d]})}},undo:function(a){this.index--;for(var b=this.saved[this.index],c=b.changes,d=c.length,f=0;f<d;f++)change=c[f],a=a.substring(0,change[0])+change[1]+a.substring(change[0]+change[2].length);return[a,b.selection[0]]},redo:function(a){for(var b=this.saved[this.index],c=b.changes,d=c.length-1;d>=0;d--)change=c[d],a=a.substring(0,change[0])+change[2]+a.substring(change[0]+
change[1].length);this.index++;return[a,b.selection[1]]},hasUndo:function(){return this.index!=0},hasRedo:function(){return this.index!=this.saved.length},_diff:function(a,b){var c=a.length,d=b.length,f=0,h=0;if(a==b)return null;for(;f<c&&f<d;){if(a[f]!=b[f])break;f++}for(;h<c&&h<d;){if(a[c-h-1]!=b[d-h-1])break;h++}f==Math.min(c,d)&&(f=0);h==Math.min(c,d)&&(h=0);if(f||h)a=a.substring(f,c-h),b=b.substring(f,d-h),c=a.length,d=b.length;return c!==d&&(h=c<d?b.indexOf(a):a.indexOf(b),h>-1)?c<d?[[f,"",
b.substr(0,h)],[f+c,"",b.substr(h+c)]]:[[f,a.substr(0,h),""],[f+h+d,a.substr(h+d),""]]:[[f,a,b]]}};g.Undo.constructor=g.Undo;g.Selection=function(a){this.$editor=a;this.top=this.$editor.get(0)};g.Selection.prototype={get:function(a){var b=window.getSelection(),c=i.createRange();if(a===l){if(!b.rangeCount)return[0,0];a=b.getRangeAt(0)}b=a.toString().replace(/\n/g,"").length;c.setStart(this.top,0);c.setEnd(a.startContainer,a.startOffset);a=c.toString().replace(/\n+/g,"").length;return[a,a+b]},set:function(a,
b){e.isArray(a)&&(b=a[1],a=a[0]);var c=window.getSelection(),d=i.createRange(),f;f=this._getOffsetNode(this.top,a);d.setStart.apply(d,f);b===l?d.collapse(!0):(f=this._getOffsetNode(this.top,b),d.setEnd.apply(d,f));c.removeAllRanges();c.addRange(d)},toString:function(a){var b=window.getSelection();a===l&&(a=b.getRangeAt(0));return a.toString()},_getOffsetNode:function(a,b){function c(a){if(a.nodeType==Node.TEXT_NODE||a.nodeType==Node.CDATA_SECTION_NODE)b>0&&(d=a,b-=a.nodeValue.replace(/\n/g,"").length);
else for(var f=0,e=a.childNodes.length;b>0&&f<e;++f)c(a.childNodes[f])}var d=a,f=0;c(a);if(b==0){if(d.nodeType!=Node.TEXT_NODE)return[d,0];for(;d.nextSibling===null;)d=d.parentNode;d=d.nextSibling}f=d.nodeValue?d.nodeValue.length:0;return[d,f+b]}};g.Selection.constructor=g.Selection;g.Commands=function(){var a={is:{},make:{}},b={makeEasy:["bold","underline","italic","strikethrough","fontname","fontsize","forecolor","createLink","insertImage"],isSelectors:{bold:"b, strong",italic:"i, em",link:"a[href]",
underline:"u, ins",indented:"blockquote",strikethrough:"s, del",orderedList:"ol",unorderedList:"ul"},isNativeState:{bold:"bold",italic:"italic",underline:"underline",strikethrough:"strikethrough",orderedList:"insertOrderedList",unorderedList:"insertUnorderedList"}};e.each(b.makeEasy,function(b,c){a.make[c]=function(b){a.execCommand(c,!1,b)}});e.each(b.isSelectors,function(c,f){a.is[c]=c in b.isNativeState?function(){return a.selectionIsWithin(f)||i.queryCommandState(b.isNativeState[c])}:function(){return a.selectionIsWithin(f)}});
var c={is:{linked:"link",underlined:"underline",struckthrough:"strikethrough",ol:"orderedList",ul:"unorderedList"},make:{italicize:"italic",font:"fontname",color:"forecolor",link:"createLink",ol:"orderedList",ul:"unorderedList",align:"alignment"}};e.each(c.is,function(b,c){a.is[b]=function(){return a.is[c]()}});e.each(c.make,function(b,c){a.make[b]=e.proxy(a.make,c)});a.noSpans=function(){try{return i.execCommand("styleWithCSS",0,!1),function(){i.execCommand("styleWithCSS",0,!1)}}catch(a){try{return i.execCommand("useCSS",
0,!0),function(){i.execCommand("useCSS",0,!0)}}catch(b){try{return i.execCommand("styleWithCSS",!1,!1),function(){i.execCommand("styleWithCSS",!1,!1)}}catch(c){return e.noop}}}}();return a}();e.extend(g.Commands,{_blockElements:g.Element.getContentElements().join(",").replace(",div,",",div:not(."+g.name+"-editor),"),styleSelectors:{fontname:"fontFamily",fontsize:"fontSize",forecolor:"color",hilitecolor:"backgroundColor",backcolor:"backgroundColor"},validCommands:["backColor","bold","createLink","fontName",
"fontSize","foreColor","hiliteColor","italic","removeFormat","strikethrough","subscript","superscript","underline","unlink","delete","formatBlock","forwardDelete","indent","insertHorizontalRule","insertHTML","insertImage","insertLineBreak","insertOrderedList","insertParagraph","insertText","insertUnorderedList","justifyCenter","justifyFull","justifyLeft","justifyRight","outdent","copy","cut","paste","selectAll","styleWithCSS","useCSS"],execCommand:function(a,b,c){this.noSpans();try{i.execCommand(a,
b,c)}catch(d){return null}},isMakeCommand:function(a){return a in this.make},isValidExecCommand:function(a){return e.inArray(a,this.validCommands)>-1},queryCommandState:function(a){if(a in this.is)return this.is[a]();try{return i.queryCommandState(a)}catch(b){return null}},selectionIsWithin:function(a){var b=g.Element.getPhraseElements(),c=!1,d=a.split(","),f=d.length,h=window.getSelection(),j=h.anchorNode,h=h.focusNode;if(j&&j.nodeType&&j.nodeType==3&&j.nodeValue=="")j=j.nextSibling;if(e.browser.mozilla){for(;f--;)if(e.inArray(d[f],
b)!=-1){c=!0;break}if(c&&j.nodeType==1&&e.inArray(j.nodeName.toLowerCase(),b)==-1&&(f=j.firstChild)){if(f.nodeValue=="")f=f.nextSibling;f.nodeType==1&&(j=f)}}if(!j)return!1;for(;j&&h&&j.nodeType!=1&&h.nodeType!=1;){if(j.nodeType!=1)j=j.parentNode;if(h.nodeType!=1)h=h.parentNode}return!(!e(j).closest(a).length&&!e(h).closest(a).length)},getSelectedStyles:function(){var a=window.getSelection(),a=e(a.getNode()),b={},c;for(c in this.styleSelectors)b[c]=a.css(this.styleSelectors[c]);return b},replaceElement:function(a,
b){if(!a.hasClass(g.name+"-editor")){for(var c=a.get(0),d=e("<"+b+"/>").html(c.innerHTML),c=c.attributes,f=c.length||0;f--;)d.attr(c[f].name,c[f].value);a.replaceWith(d);return d}},deleteElement:function(){var a=e(this);a.replaceWith(a.html())},stripFormattingElements:function(){function a(b,f){var d=e(f);d.children().each(a);c(d)&&deleteElement.apply(d)}for(var b=window.getSelection(),c=g.Element.isFormatter,d=b.rangeCount,f=[],h;d--;)h=b.getRangeAt(d),f.push(h),this.getRangeElements(h,this._blockElements).each(a);
this.restoreRanges(f)},manipulateSelection:function(){for(var a=window.getSelection(),b=a.rangeCount,c=[],d=arguments,f=d[0],e;b--;)e=a.getRangeAt(b),c.push(e),d[0]=e,f.apply(this,d);this.restoreRanges(c)},getRangeElements:function(a,b){var c=e(a.startContainer).closest(b),d=e(a.endContainer).closest(b),f=e("nullset");c.parents(".WysiHat-editor").length&&d.parents(".WysiHat-editor").length&&(f=c,c.filter(d).length||(f=c.nextAll().filter(d).length?c.nextUntil(d).andSelf().add(d):c.prevUntil(d).andSelf().add(d)));
return f},getRanges:function(){for(var a=window.getSelection(),b=a.rangeCount,c=[],d;b--;)d=a.getRangeAt(b),c.push(d);return c},restoreRanges:function(a){var b=window.getSelection(),c=a.length;for(b.removeAllRanges();c--;)b.addRange(a[c])},changeContentBlock:function(a){for(var b=window.getSelection(),c=this,d=e(c),f=b.rangeCount,h=[],j;f--;)j=b.getRangeAt(f),h.push(j),this.getRangeElements(j,this._blockElements).each(function(){c.replaceElement(e(this),a)}).data("WysiHat-replaced",!0);d.children(a).removeData("WysiHat-replaced");
this.restoreRanges(h)},unformatContentBlock:function(){this.changeContentBlock("p")},unlinkSelection:function(){this.manipulateSelection(function(a){this.getRangeElements(a,"[href]").each(this.clearElement)})},wrapHTML:function(){var a=window.getSelection(),b=a.getRangeAt(0),c=a.getNode(),d=arguments.length;b.collapsed&&(b=i.createRange(),b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b));for(b=a.getRangeAt(0);d--;)a=e("<"+arguments[d]+"/>"),b.surroundContents(a.get(0))},toggleHTML:function(a){var b=
a.$editor,a=a.$element,c=b.data("field"),d=a.siblings(),f=a.data("text");b.is(":visible")?(a.find("b").text(a.data("toggle-text")),d.hide(),b.hide(),c.show()):(a.find("b").text(f),d.show(),c.hide(),b.show())},insertHTML:function(a){if(e.browser.msie){var b=i.selection.createRange();b.pasteHTML(a);b.collapse(!1);b.select()}else this.execCommand("insertHTML",!1,a)},quoteSelection:function(){this.manipulateSelection(function(a,b){var c=b.clone(),d=this.getRangeElements(a,this._blockElements),f=d.length-
1,h=e();d.each(function(a){var b=e(this),d=!1;g.Element.isSubContainer(b)&&(d=!0);!a&&d&&a==f?(d=e("<p/>").html(b.html()),b.html("").append(d),h=h.add(d)):h=d?h.add(b.closest(g.Element.getContainers().join(","))):h.add(b);a==f&&h.wrapAll(c)})},e("<blockquote/>"))},unquoteSelection:function(){this.manipulateSelection(function(a){this.getRangeElements(a,"blockquote > *").each(function(){var a=this,c=e(a),d=c.closest("blockquote"),f=d.clone().html(""),d=d.children(),h=d.length-1,j=e();c.unwrap("blockquote");
h>0&&d.each(function(c){this!=a&&(j=j.add(this));if(c==h||this==a)j.wrapAll(f.clone()),j=e()});d=c.parent();g.Element.isSubContainer(d)&&d.children().length==1&&d.html(c.html())})})},toggleList:function(a){var b=e("<"+a+"/>"),c=a=="ul"?"ol":"ul",d=this;this.is[a]()?this.manipulateSelection(function(b){this.getRangeElements(b,a).each(function(){var a=e(this);a.children("li").each(function(){var a=e(this);d.replaceElement(a,"p");a.find("ol,ul").each(function(){var a=e(this).parent();a.is("p")&&d.deleteElement.apply(a)})});
d.deleteElement.apply(a)})}):this.manipulateSelection(function(b,h){var g=h.clone();this.getRangeElements(b,this._blockElements).each(function(b){var f=e(this);f.parent().is(c)?(d.replaceElement(f.parent(),a),g=f.parent()):(b||f.replaceWith(g),f.appendTo(g))});g.children(":not(li)").each(function(){d.replaceElement(e(this),"li")})},b)}});e.extend(g.Commands.make,{blockquote:function(){g.Commands.is.indented()?g.Commands.unquoteSelection():g.Commands.quoteSelection()},orderedList:function(){g.Commands.toggleList("ol")},
unorderedList:function(){g.Commands.toggleList("ul")},alignment:function(a){g.Commands.execCommand("justify"+a)},backgroundColor:function(a){g.Commands.execCommand(e.browser.mozilla?"hilitecolor":"backcolor",!1,a)}});var o={is:function(a){return g.Commands.is[a]()},make:function(a,b){return g.Commands.make[a](b)},toggle:function(a,b){return g.Commands.make[a](b)}};e.extend(g.Editor.prototype,o);g.Formatting={cleanup:function(a){var b=g.Commands.replaceElement;a.contents().filter(function(){return this.nodeType==
Node.COMMENT_NODE}).remove();a.find("br").replaceWith("\n").end().find("span").each(function(){var a=e(this);a.hasClass("Apple-style-span")&&a.removeClass("Apple-style-span");a.css("font-weight")=="bold"&&a.css("font-style")=="italic"?(a.removeAttr("style").wrap("<strong>"),b(a,"em")):a.css("font-weight")=="bold"?b(a.removeAttr("style"),"strong"):a.css("font-style")=="italic"&&b(a.removeAttr("style"),"em")}).end().children("div").each(function(){this.attributes.length||b(e(this),"p")}).end().find("b").each(function(){b(e(this),
"strong")}).end().find("i").each(function(){b(e(this),"em")}).end().find("strike").each(function(){b(e(this),"del")}).end().find("u").each(function(){b(e(this),"ins")}).end().find("p:empty,script,noscript,style").remove()},cleanupPaste:function(a,b){this.cleanup(a);var c=a.find("*"),c=e.makeArray(c).reverse();e.each(c,function(){var a=this.nodeName.toLowerCase(),b=i.createElement(a);switch(a){case "a":b.href=this.href;b.title=this.title;break;case "img":b.src=this.src,b.alt=this.alt}b.innerHTML=this.innerHTML;
e(this).replaceWith(b)});a.find("span").children(g.Element.getBlocks()).unwrap();a.find(":empty").remove();b.toLowerCase()!="p"&&a.find(b).replaceWith(function(a,b){return b});var d,f=[];for(a.find("p ~ p").each(function(){var a=e(this),b=a.prev();d?e.trim(b.html())||(d.after("\n"),d=f.pop()):d=b;d.html(function(b,c){var f=e.trim(a.html());(c=e.trim(c))&&f&&(c+="<br>");return c+f});f.push(a)});d=f.pop();)d.remove()},reBlocks:RegExp("(<(?:ul|ol)>|</(?:"+g.Element.getBlocks().join("|")+")>)[\r\n]*",
"g"),format:function(a){a.html(function(a,c){return c.replace("<p>&nbsp;</p>","").replace(/<br\/?><\/p>/,"</p>").replace(this.reBlocks,"$1\n").replace(/\n+/,"\n").replace(/<p>\n+<\/p>/,"")})},getBrowserMarkupFrom:function(a){var a=e("<div>"+a.val().replace(/\n/,"")+"</div>"),b;this.cleanup(a);b=a.html();(b==""||b=="<br>"||b=="<br/>")&&a.html("<p>&#x200b;</p>");return a.html()},getApplicationMarkupFrom:function(a){var a=a.clone(),b,a=e("<div/>").html(a.html());b=a.html();(b==""||b=="<br>"||b=="<br/>")&&
a.html("<p>&#x200b;</p>");this.cleanup(a);this.format(a);a.find("*").html(function(a,b){return b.replace("\n","<br>\n").replace(/(\t| +)/g," ")});return a.html().replace(/<\/?[A-Z]+/g,function(a){return a.toLowerCase()})}};var k={init:function(a,b){this.name=a;this.$editor=b;return this},setElement:function(a){this.$element=e(a);return this},getHandler:function(){if(this.handler)return e.proxy(this,"handler");var a=this;if(g.Commands.isMakeCommand(this.name))return function(){return g.Commands.make[a.name]()};
else if(g.Commands.isValidExecCommand(this.name))return function(){return g.Commands.execCommand(a.name)};return e.noop},getStateHandler:function(){if(this.query)return e.proxy(this,"query");else if(g.Commands.isValidExecCommand(this.name)){var a=this;return function(b){return b.data("wysihat").Commands.queryCommandState(a.name)}}return e.noop},setOn:function(){this.$element.addClass("selected").attr("aria-pressed","true").find("b").text(this["toggle-text"]?this["toggle-text"]:this.label);return this},
setOff:function(){this.$element.removeClass("selected").attr("aria-pressed","false").find("b").text(this.label);return this}};g.Toolbar=function(a,b){this.$editor=a;this.$toolbar=e('<div class="'+g.name+'-editor-toolbar" role="presentation"></div>');a.before(this.$toolbar);var c=b.length,d;for(d=0;d<c;d++)this.addButton(b[d])};g.Toolbar.prototype={addButton:function(a){var b=this.$editor.data("wysihat"),c=g.inherit(k,g._buttons[a]).init(a,b.$editor);e.extend(c,o);c.Event=b.Event;c.Commands=b.Commands;
c.Selection=b.Selection;c.setElement(this.createButtonElement(c));c.Event.add(a,c.getHandler());this.observeButtonClick(c);this.observeStateChanges(c)},createButtonElement:function(a){var b;if(a.type&&a.type=="select"){var c=a.options,d=c.length,f=0;for(b=e('<select class="button picker"/>');f<d;f++)b.append('<option value="'+c[f][0]+'">'+c[f][1]+"</option>")}else b=e('<button aria-pressed="false" tabindex="-1"></button>'),b.append("<b>"+a.label+"</b>").addClass("button "+a.name).hover(function(){this.title=
e(this).find("b").text()},function(){e(this).removeAttr("title")});b.appendTo(this.$toolbar);a.cssClass&&b.addClass(a.cssClass);a.title&&b.attr("title",a.title);b.data("text",a.label);a["toggle-text"]&&b.data("toggle-text",a["toggle-text"]);return b},observeButtonClick:function(a){a.$element.on(a.type&&a.type=="select"?"change":"click",function(){var b=a.$editor;b.is(":focus")||b.focus();a.Event.fire(a.name);return!1})},observeStateChanges:function(a){var b=this,c=a.getStateHandler(),d;b.$editor.on("WysiHat-selection:change",
function(){var f=c(a.$editor,a.$element);f!=d&&(d=f,b.updateButtonState(a,f))})},updateButtonState:function(a,b){b?a.setOn():a.setOff()}};g.Toolbar.constructor=g.Toolbar})(document,jQuery);jQuery.fn.wysihat=function(i){var e=this.data("wysihat");return e?jQuery.inArray(i,["Event","Selection","Toolbar","Undo"])!=-1?e[i]:e:this.each(function(){WysiHat.attach(this,i)})};
(function(i,e){window.getSelection||function(e){var a={isDataNode:function(a){try{return a&&a.nodeValue!==null&&a.data!==null}catch(c){return!1}},isAncestorOf:function(b,c){return!b?!1:!a.isDataNode(b)&&(c.parentNode==b||b.contains(a.isDataNode(c)?c.parentNode:c))},isAncestorOrSelf:function(b,c){return b==c||a.isAncestorOf(b,c)},findClosestAncestor:function(b,c){if(a.isAncestorOf(b,c))for(;c&&c.parentNode!=b;)c=c.parentNode;return c},getNodeLength:function(b){return a.isDataNode(b)?b.length:b.childNodes.length},
splitDataNode:function(b,c){if(!a.isDataNode(b))return!1;var d=b.cloneNode(!1);b.deleteData(c,b.length);d.deleteData(0,c);b.parentNode.insertBefore(d,b.nextSibling)}};window.Range=function(){function b(b){this._document=b;this.startContainer=this.endContainer=b.body;this.endOffset=a.getNodeLength(b.body)}function c(a){for(var b=0;a=a.previousSibling;b++);return b}function d(b){this.range=b;if(!b.collapsed){var c=b.commonAncestorContainer;this._next=b.startContainer==c&&!a.isDataNode(b.startContainer)?
b.startContainer.childNodes[b.startOffset]:a.findClosestAncestor(c,b.startContainer);this._end=b.endContainer==c&&!a.isDataNode(b.endContainer)?b.endContainer.childNodes[b.endOffset]:a.findClosestAncestor(c,b.endContainer).nextSibling}}b.prototype={START_TO_START:0,START_TO_END:1,END_TO_END:2,END_TO_START:3,startContainer:null,startOffset:0,endContainer:null,endOffset:0,commonAncestorContainer:null,collapsed:!1,_document:null,_toTextRange:function(){function b(c,f,d){var e=f[d?"startContainer":"endContainer"],
g=f[d?"startOffset":"endOffset"],h=0;a.isDataNode(e);a.isDataNode(e);f._document.createElement("a");f=f._document.body.createTextRange();if(e.nodeType==3||e.nodeType==4)h=g;c.setEndPoint(d?"StartToStart":"EndToStart",f);c[d?"moveStart":"moveEnd"]("character",h)}var c=this._document.body.createTextRange();b(c,this,!0);b(c,this,!1);return c},_refreshProperties:function(){this.collapsed=this.startContainer==this.endContainer&&this.startOffset==this.endOffset;for(var b=this.startContainer;b&&b!=this.endContainer&&
!a.isAncestorOf(b,this.endContainer);)b=b.parentNode;this.commonAncestorContainer=b},setStart:function(a,b){this.startContainer=a;this.startOffset=b;this._refreshProperties()},setEnd:function(a,b){this.endContainer=a;this.endOffset=b;this._refreshProperties()},setStartBefore:function(a){this.setStart(a.parentNode,c(a))},setStartAfter:function(a){this.setStart(a.parentNode,c(a)+1)},setEndBefore:function(a){this.setEnd(a.parentNode,c(a))},setEndAfter:function(a){this.setEnd(a.parentNode,c(a)+1)},selectNode:function(a){this.setStartBefore(a);
this.setEndAfter(a)},selectNodeContents:function(b){this.setStart(b,0);this.setEnd(b,a.getNodeLength(b))},collapse:function(a){a?this.setEnd(this.startContainer,this.startOffset):this.setStart(this.endContainer,this.endOffset)},cloneContents:function(){return function h(a){for(var b,c=i.createDocumentFragment();b=a.next();)b=b.cloneNode(!a.hasPartialSubtree()),a.hasPartialSubtree()&&b.appendChild(h(a.getSubtreeIterator())),c.appendChild(b);return c}(new d(this))},extractContents:function(){var b=
this.cloneRange();this.startContainer!=this.commonAncestorContainer&&this.setStartAfter(a.findClosestAncestor(this.commonAncestorContainer,this.startContainer));this.collapse(!0);return function j(a){for(var b,c=i.createDocumentFragment();b=a.next();)a.hasPartialSubtree()?b=b.cloneNode(!1):a.remove(),a.hasPartialSubtree()&&b.appendChild(j(a.getSubtreeIterator())),c.appendChild(b);return c}(new d(b))},deleteContents:function(){var b=this.cloneRange();this.startContainer!=this.commonAncestorContainer&&
this.setStartAfter(a.findClosestAncestor(this.commonAncestorContainer,this.startContainer));this.collapse(!0);(function j(a){for(;a.next();)a.hasPartialSubtree()?j(a.getSubtreeIterator()):a.remove()})(new d(b))},insertNode:function(b){if(a.isDataNode(this.startContainer))a.splitDataNode(this.startContainer,this.startOffset),this.startContainer.parentNode.insertBefore(b,this.startContainer.nextSibling);else{var c=this.startContainer.childNodes[this.startOffset];c?this.startContainer.insertBefore(b,
c):this.startContainer.appendChild(b)}this.setStart(this.startContainer,this.startOffset)},surroundContents:function(a){var b=this.extractContents();this.insertNode(a);a.appendChild(b);this.selectNode(a)},compareBoundaryPoints:function(a,b){var c,d,e,g;switch(a){case this.START_TO_START:case this.START_TO_END:c=this.startContainer;d=this.startOffset;break;case this.END_TO_END:case this.END_TO_START:c=this.endContainer,d=this.endOffset}switch(a){case this.START_TO_START:case this.END_TO_START:e=b.startContainer;
g=b.startOffset;break;case this.START_TO_END:case this.END_TO_END:e=b.endContainer,g=b.endOffset}return c.sourceIndex<e.sourceIndex?-1:c.sourceIndex==e.sourceIndex?d<g?-1:d==g?0:1:1},cloneRange:function(){var a=new b(this._document);a.setStart(this.startContainer,this.startOffset);a.setEnd(this.endContainer,this.endOffset);return a},toString:function(){return this._toTextRange().text},createContextualFragment:function(b){var c=(a.isDataNode(this.startContainer)?this.startContainer.parentNode:this.startContainer).cloneNode(!1),
d=this._document.createDocumentFragment();for(c.innerHTML=b;c.firstChild;)d.appendChild(c.firstChild);return d}};d.prototype={range:null,_current:null,_next:null,_end:null,hasNext:function(){return!!this._next},next:function(){var b=this._current=this._next;this._next=this._current&&this._current.nextSibling!=this._end?this._current.nextSibling:null;a.isDataNode(this._current)&&(this.range.endContainer==this._current&&(b=b.cloneNode(!0)).deleteData(this.range.endOffset,b.length-this.range.endOffset),
this.range.startContainer==this._current&&(b=b.cloneNode(!0)).deleteData(0,this.range.startOffset));return b},remove:function(){if(a.isDataNode(this._current)&&(this.range.startContainer==this._current||this.range.endContainer==this._current)){var b=this.range.startContainer==this._current?this.range.startOffset:0;this._current.deleteData(b,(this.range.endContainer==this._current?this.range.endOffset:this._current.length)-b)}else this._current.parentNode.removeChild(this._current)},hasPartialSubtree:function(){return!a.isDataNode(this._current)&&
(a.isAncestorOrSelf(this._current,this.range.startContainer)||a.isAncestorOrSelf(this._current,this.range.endContainer))},getSubtreeIterator:function(){var c=new b(this.range._document);c.selectNodeContents(this._current);a.isAncestorOrSelf(this._current,this.range.startContainer)&&c.setStart(this.range.startContainer,this.range.startOffset);a.isAncestorOrSelf(this._current,this.range.endContainer)&&c.setEnd(this.range.endContainer,this.range.endOffset);return new d(c)}};return b}();window.Range._fromTextRange=
function(a,c){function d(a,b,d){var e=c.createElement("a"),f=b.duplicate(),g;f.collapse(d);g=f.parentElement();do g.insertBefore(e,e.previousSibling),f.moveToElementText(e);while(e.previousSibling&&f.compareEndPoints(d?"StartToStart":"StartToEnd",b)>0);if(e.nextSibling&&f.compareEndPoints(d?"StartToStart":"StartToEnd",b)==-1)f.setEndPoint(d?"EndToStart":"EndToEnd",b),a[d?"setStart":"setEnd"](e.nextSibling,f.text.length);else a[d?"setStartBefore":"setEndBefore"](e);e.parentNode.removeChild(e)}var e=
new Range(c);d(e,a,!0);d(e,a,!1);return e};i.createRange=function(){return new Range(i)};window.Selection=function(){function a(b){this._document=b;var d=this;b.attachEvent("onselectionchange",function(){d._selectionChangeHandler()});setTimeout(function(){d._selectionChangeHandler()},10)}a.prototype={rangeCount:0,_document:null,anchorNode:null,focusNode:null,_selectionChangeHandler:function(){var a=this._document.selection.createRange(),b=a.text.split(/\r|\n/),f=e(a.parentElement()),g,i;b.length>
1?(g=RegExp(b[0]+"$"),i=RegExp("^"+b[b.length-1]),f.children().each(function(){if(e(this).text().match(g))this.anchorNode=this;if(e(this).text().match(i))this.focusNode=this})):this.focusNode=this.anchorNode=f.get(0);this.rangeCount=this._selectionExists(a)?1:0},_selectionExists:function(a){return a.parentElement().isContentEditable||a.compareEndPoints("StartToEnd",a)!=0},addRange:function(a){var b=this._document.selection.createRange(),a=a._toTextRange();if(this._selectionExists(b))a.compareEndPoints("StartToStart",
b)==-1?a.compareEndPoints("StartToEnd",b)>-1&&a.compareEndPoints("EndToEnd",b)==-1&&b.setEndPoint("StartToStart",a):a.compareEndPoints("EndToStart",b)<1&&a.compareEndPoints("EndToEnd",b)>-1&&b.setEndPoint("EndToEnd",a),b.select();else try{a.select()}catch(e){}},removeAllRanges:function(){this._document.selection.empty()},getRangeAt:function(){var a=this._document.selection.createRange();return this._selectionExists(a)?Range._fromTextRange(a,this._document):null},toString:function(){return this._document.selection.createRange().text},
isCollapsed:function(){return i.createRange().collapsed},deleteFromDocument:function(){this._document.selection.createRange().pasteHTML("")}};return a}();window.getSelection=function(){var a=new l(i);return function(){return a}}()}(jQuery);typeof Node=="undefined"&&function(){window.Node=new function(){return{ATTRIBUTE_NODE:2,CDATA_SECTION_NODE:4,COMMENT_NODE:8,DOCUMENT_FRAGMENT_NODE:11,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,ELEMENT_NODE:1,ENTITY_NODE:6,ENTITY_REFERENCE_NODE:5,NOTATION_NODE:12,PROCESSING_INSTRUCTION_NODE:7,
TEXT_NODE:3}}}();e.extend(Range.prototype,{beforeRange:function(e){return!e||!e.compareBoundaryPoints?!1:this.compareBoundaryPoints(this.START_TO_START,e)==-1&&this.compareBoundaryPoints(this.START_TO_END,e)==-1&&this.compareBoundaryPoints(this.END_TO_END,e)==-1&&this.compareBoundaryPoints(this.END_TO_START,e)==-1},afterRange:function(e){return!e||!e.compareBoundaryPoints?!1:this.compareBoundaryPoints(this.START_TO_START,e)==1&&this.compareBoundaryPoints(this.START_TO_END,e)==1&&this.compareBoundaryPoints(this.END_TO_END,
e)==1&&this.compareBoundaryPoints(this.END_TO_START,e)==1},betweenRange:function(e){return!e||!e.compareBoundaryPoints?!1:!(this.beforeRange(e)||this.afterRange(e))},equalRange:function(e){return!e||!e.compareBoundaryPoints?!1:this.collapsed&&e.collapsed?this.compareBoundaryPoints(this.START_TO_START,e)==0:this.compareBoundaryPoints(this.START_TO_START,e)==0&&this.compareBoundaryPoints(this.START_TO_END,e)==1&&this.compareBoundaryPoints(this.END_TO_END,e)==0&&this.compareBoundaryPoints(this.END_TO_START,
e)==-1},getNode:function(){for(var g=this.commonAncestorContainer,a=this,b;g.nodeType==Node.TEXT_NODE;)g=g.parentNode;e(g).children().each(function(){var c=i.createRange();c.selectNodeContents(this);b=a.betweenRange(c)});return e(b||g).get(0)}});if(typeof l=="undefined"){var l={};l.prototype=window.getSelection().__proto__}var g,m,n,o;e.browser.msie?(g=function(){var g=this._document.selection.createRange();return e(g.parentElement())},m=function(e){var a=this._document.body.createTextRange();a.moveToElementText(e);
a.select()},n=function(){var g=e("#WysiHat-bookmark"),a=e("<div/>"),b=this._document.selection.createRange();g.length>0&&g.remove();e('<span id="WysiHat-bookmark">&nbsp;</span>').appendTo(a);b.collapse(!0);b.pasteHTML(a.html())},o=function(){var g=e("#WysiHat-bookmark"),a=this._document.selection.createRange();g.length>0&&g.remove();a.moveToElementText(g.get(0));a.collapse(!0);a.select();g.remove()}):(g=function(){return this.rangeCount>0?this.getRangeAt(0).getNode():null},m=function(e){var a=i.createRange();
a.selectNode(e[0]);this.removeAllRanges();this.addRange(a)},n=function(){var g=e("#WysiHat-bookmark");g.length>0&&g.remove();g=e('<span id="WysiHat-bookmark">&nbsp;</span>');this.getRangeAt(0).insertNode(g.get(0))},o=function(){var g=e("#WysiHat-bookmark"),a=i.createRange();g.length>0&&g.remove();a.setStartBefore(g.get(0));this.removeAllRanges();this.addRange(a);g.remove()});e.extend(l.prototype,{getNode:g,selectNode:m,setBookmark:n,moveToBookmark:o})})(document,jQuery);
