/**
 * jquery.Jcrop.js v0.9.8
 * jQuery Image Cropping Plugin
 * @author Kelly Hallman <khallman@gmail.com>
 * Copyright (c) 2008-2009 Kelly Hallman - released under MIT License {{{
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following
 * conditions:

 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.

 * }}}
 */

(function(g){g.Jcrop=function(v,x){function f(a){return""+parseInt(a)+"px"}function F(a){a=g(a).offset();return[a.left,a.top]}function Q(a){return[a.pageX-R[0],a.pageY-R[1]]}function Ga(a,c){return function(b){if(d.aspectRatio)switch(a){case "e":b[1]=c.y+1;break;case "w":b[1]=c.y+1;break;case "n":b[0]=c.x+1;break;case "s":b[0]=c.x+1}else switch(a){case "e":b[1]=c.y2;break;case "w":b[1]=c.y2;break;case "n":b[0]=c.x2;break;case "s":b[0]=c.x2}k.setCurrent(b);q.update()}}function Ha(a){var c=a;S.watchKeys();
return function(a){k.moveOffset([a[0]-c[0],a[1]-c[1]]);c=a;q.update()}}function ka(a){switch(a){case "n":return"sw";case "s":return"nw";case "e":return"nw";case "w":return"ne";case "ne":return"sw";case "nw":return"se";case "se":return"nw";case "sw":return"ne"}}function la(a){return function(c){if(d.disabled||"move"==a&&!d.allowMove)return!1;H=!0;var b=Q(c);R=F(u);z.setCursor("move"==a?a:a+"-resize");if("move"==a)z.activateHandlers(Ha(b),Z);else{var b=k.getFixed(),e=ka(a),g=k.getCorner(ka(e));k.setPressed(k.getCorner(e));
k.setCurrent(g);z.activateHandlers(Ga(a,b),Z)}c.stopPropagation();c.preventDefault();return!1}}function $(a){return{x:parseInt(a.x*y),y:parseInt(a.y*A),x2:parseInt(a.x2*y),y2:parseInt(a.y2*A),w:parseInt(a.w*y),h:parseInt(a.h*A)}}function Z(){var a=k.getFixed();a.w>d.minSelect[0]&&a.h>d.minSelect[1]?(q.enableHandles(),q.done()):q.release();z.setCursor(d.allowSelect?"crosshair":"default")}function Ia(a){k.setCurrent(a);q.update()}function ma(){var a=g("<div></div>").addClass(d.baseClass+"-tracker");
g.browser.msie&&a.css({opacity:0,backgroundColor:"white"});return a}function na(a){oa([a[0]/y,a[1]/A,a[2]/y,a[3]/A])}function oa(a){k.setPressed([a[0],a[1]]);k.setCurrent([a[2],a[3]]);q.update()}function pa(a){"object"!=typeof a&&(a={});d=g.extend(d,a);"function"!==typeof d.onChange&&(d.onChange=function(){});"function"!==typeof d.onSelect&&(d.onSelect=function(){})}function aa(a){d.allowResize?a?q.enableOnly():q.enableHandles():q.disableHandles();z.setCursor(d.allowSelect?"crosshair":"default");
q.setCursor(d.allowMove?"move":"default");ba.css("backgroundColor",d.bgColor);"setSelect"in d&&(na(x.setSelect),q.done(),delete d.setSelect);"trueSize"in d&&(y=d.trueSize[0]/t,A=d.trueSize[1]/s);I=d.maxSize[0]||0;J=d.maxSize[1]||0;K=d.minSize[0]||0;L=d.minSize[1]||0;"outerImage"in d&&(u.attr("src",d.outerImage),delete d.outerImage);q.refresh()}"object"!==typeof v&&(v=g(v)[0]);"object"!==typeof x&&(x={});"trackDocument"in x||(x.trackDocument=g.browser.msie?!1:!0,g.browser.msie&&"8"==g.browser.version.split(".")[0]&&
(x.trackDocument=!0));"keySupport"in x||(x.keySupport=g.browser.msie?!1:!0);var d={trackDocument:!1,baseClass:"jcrop",addClass:null,bgColor:"black",bgOpacity:0.6,borderOpacity:0.4,handleOpacity:0.5,handlePad:5,handleSize:9,handleOffset:5,edgeMargin:14,aspectRatio:0,keySupport:!0,cornerHandles:!0,sideHandles:!0,drawBorders:!0,dragEdges:!0,boxWidth:0,boxHeight:0,boundary:8,animationDelay:20,swingSpeed:3,allowSelect:!0,allowMove:!0,allowResize:!0,minSelect:[0,0],maxSize:[0,0],minSize:[0,0],onChange:function(){},
onSelect:function(){}};pa(x);var D=g(v),u=D.clone().removeAttr("id").css({position:"absolute"});u.width(D.width());u.height(D.height());D.after(u).hide();var n=u,B=d.boxWidth,E=d.boxHeight,M=n.width(),N=n.height();M>B&&0<B&&(M=B,N=B/n.width()*n.height());N>E&&0<E&&(N=E,M=E/n.height()*n.width());y=n.width()/M;A=n.height()/N;n.width(M).height(N);var t=u.width(),s=u.height(),ba=g("<div />").width(t).height(s).addClass(d.baseClass+"-holder").css({position:"relative",backgroundColor:d.bgColor}).insertAfter(D).append(u);
d.addClass&&ba.addClass(d.addClass);var qa=g("<img />").attr("src",u.attr("src")).css("position","absolute").width(t).height(s),ca=g("<div />").width("100%").height("100%").css({zIndex:310,position:"absolute",overflow:"hidden"}).append(qa),G=g("<div />").width("100%").height("100%").css("zIndex",320),T=g("<div />").css({position:"absolute",zIndex:300}).insertBefore(u).append(ca,G),n=d.boundary,O=ma().width(t+2*n).height(s+2*n).css({position:"absolute",top:f(-n),left:f(-n),zIndex:290}).mousedown(function(a){if(d.disabled||
!d.allowSelect)return!1;H=!0;R=F(u);q.disableHandles();"crosshair"!=ra&&(z.setCursor("crosshair"),ra="crosshair");var c=Q(a);k.setPressed(c);z.activateHandlers(Ia,Z);S.watchKeys();q.update();a.stopPropagation();a.preventDefault();return!1}),I,J,K,L,y,A,R=F(u),H,ra,sa,Ja,k,ua=function(){if(!d.aspectRatio){var a=p-b,c=l-e;I&&Math.abs(a)>I&&(p=0<a?b+I:b-I);J&&Math.abs(c)>J&&(l=0<c?e+J:e-J);L&&Math.abs(c)<L&&(l=0<c?e+L:e-L);K&&Math.abs(a)<K&&(p=0<a?b+K:b-K);0>b&&(p-=b,b-=b);0>e&&(l-=e,e-=e);0>p&&(b-=
p,p-=p);0>l&&(e-=l,l-=l);p>t&&(a=p-t,b-=a,p-=a);l>s&&(a=l-s,e-=a,l-=a);b>t&&(a=b-s,l-=a,e-=a);e>s&&(a=e-s,l-=a,e-=a);return ta(da(b,e,p,l))}var a=d.aspectRatio,c=d.minSize[0]/y,g=d.maxSize[0]/y,f=p-b,k=l-e,r=Math.abs(f),j=Math.abs(k);0==g&&(g=10*t);r/j<a?(r=l,w=j*a,j=0>f?b-w:w+b,0>j?(j=0,h=Math.abs((j-b)/a),r=0>k?e-h:h+e):j>t&&(j=t,h=Math.abs((j-b)/a),r=0>k?e-h:h+e)):(j=p,h=r/a,r=0>k?e-h:e+h,0>r?(r=0,w=Math.abs((r-e)*a),j=0>f?b-w:w+b):r>s&&(r=s,w=Math.abs(r-e)*a,j=0>f?b-w:w+b));j>b?(j-b<c?j=b+c:j-
b>g&&(j=b+g),r=r>e?e+(j-b)/a:e-(j-b)/a):j<b&&(b-j<c?j=b-c:b-j>g&&(j=b-g),r=r>e?e+(b-j)/a:e-(b-j)/a);0>j?(b-=j,j=0):j>t&&(b-=j-t,j=t);0>r?(e-=r,r=0):r>s&&(e-=r-s,r=s);return last=ta(da(b,e,j,r))},va=function(a){0>a[0]&&(a[0]=0);0>a[1]&&(a[1]=0);a[0]>t&&(a[0]=t);a[1]>s&&(a[1]=s);return[a[0],a[1]]},da=function(a,c,d,b){var e=a,g=d,j=c,f=b;d<a&&(e=d,g=a);b<c&&(j=b,f=c);return[Math.round(e),Math.round(j),Math.round(g),Math.round(f)]},ta=function(a){return{x:a[0],y:a[1],x2:a[2],y2:a[3],w:a[2]-a[0],h:a[3]-
a[1]}},b=0,e=0,p=0,l=0,wa,xa;k={flipCoords:da,setPressed:function(a){a=va(a);p=b=a[0];l=e=a[1]},setCurrent:function(a){a=va(a);wa=a[0]-p;xa=a[1]-l;p=a[0];l=a[1]},getOffset:function(){return[wa,xa]},moveOffset:function(a){var c=a[0],a=a[1];0>b+c&&(c-=c+b);0>e+a&&(a-=a+e);s<l+a&&(a+=s-(l+a));t<p+c&&(c+=t-(p+c));b+=c;p+=c;e+=a;l+=a},getCorner:function(a){var c=ua();switch(a){case "ne":return[c.x2,c.y];case "nw":return[c.x,c.y];case "se":return[c.x2,c.y2];case "sw":return[c.x,c.y2]}},getFixed:ua};var q,
n=function(a){a=g("<div />").css({position:"absolute",opacity:d.borderOpacity}).addClass(d.baseClass+"-"+a);ca.append(a);return a},ya=function(a,c){var d=g("<div />").mousedown(la(a)).css({cursor:a+"-resize",position:"absolute",zIndex:c});G.append(d);return d},B=function(a){var c=d.handleSize,b=C,e=c;switch(a){case "n":case "s":c="100%";break;case "e":case "w":e="100%"}return ya(a,za++).width(c).height(e).css({top:f(-b+1),left:f(-b+1)})},E=function(a){for(i in a)m[a[i]]=ya(a[i],za++).css({top:f(-C+
1),left:f(-C+1),opacity:d.handleOpacity}).addClass(d.baseClass+"-handle")},ea=function(a){var c=Math.round(a.h/2-C),d=Math.round(a.w/2-C);west=-C+1;var b=a.w-C,a=a.h-C;"e"in m&&m.e.css({top:f(c),left:f(b)})&&m.w.css({top:f(c)})&&m.s.css({top:f(a),left:f(d)})&&m.n.css({left:f(d)});"ne"in m&&m.ne.css({left:f(b)})&&m.se.css({top:f(a),left:f(b)})&&m.sw.css({top:f(a)});"b"in m&&m.b.css({top:f(a)})&&m.r.css({left:f(b)})},Ba=function(){var a=k.getFixed();k.setPressed([a.x,a.y]);k.setCurrent([a.x2,a.y2]);
Aa()},Aa=function(){if(U)return Ca()},Ca=function(){var a=k.getFixed(),c=a.h;T.width(a.w).height(c);var c=a.x,b=a.y;qa.css({top:f(-b),left:f(-c)});T.css({top:f(b),left:f(c)});d.drawBorders&&fa.right.css({left:f(a.w-1)})&&fa.bottom.css({top:f(a.h-1)});P&&ea(a);U||(T.show(),u.css("opacity",d.bgOpacity),U=!0);d.onChange($(a))},Da=function(){P=!0;if(d.allowResize)return ea(k.getFixed()),G.show(),!0},V=function(){P=!1;G.hide()},Ea=function(a){(sa=a)?V():Da()},U,za=370,fa={},m={},P=!1,C=d.handleOffset;
d.drawBorders&&(fa={top:n("hline").css("top",g.browser.msie?f(-1):f(0)),bottom:n("hline"),left:n("vline"),right:n("vline")});d.dragEdges&&(m.t=B("n"),m.b=B("s"),m.r=B("e"),m.l=B("w"));d.sideHandles&&E(["n","s","e","w"]);d.cornerHandles&&E(["sw","nw","ne","se"]);var Fa=ma().mousedown(la("move")).css({cursor:"move",position:"absolute",zIndex:360});ca.append(Fa);V();q={updateVisible:Aa,update:Ca,release:function(){V();T.hide();u.css("opacity",1);U=!1},refresh:Ba,setCursor:function(a){Fa.css("cursor",
a)},enableHandles:Da,enableOnly:function(){P=!0},showHandles:function(){P&&(ea(k.getFixed()),G.show())},disableHandles:V,animMode:Ea,done:function(){Ea(!1);Ba()}};var z,ha=function(a){ga(Q(a))},W=function(a){a.preventDefault();a.stopPropagation();H&&(H=!1,ia(Q(a)),d.onSelect($(k.getFixed())),O.css({zIndex:290}),ja&&g(document).unbind("mousemove",ha).unbind("mouseup",W),ga=function(){},ia=function(){});return!1},ga=function(){},ia=function(){},ja=d.trackDocument;ja||O.mousemove(ha).mouseup(W).mouseout(W);
u.before(O);z={activateHandlers:function(a,c){H=!0;ga=a;ia=c;O.css({zIndex:450});ja&&g(document).mousemove(ha).mouseup(W);return!1},setCursor:function(a){O.css("cursor",a)}};var S,X=function(a,c,b){d.allowMove&&(k.moveOffset([c,b]),q.updateVisible());a.preventDefault();a.stopPropagation()},Y=g('<input type="radio" />').css({position:"absolute",left:"-30px"}).keypress(function(a){if(a.ctrlKey)return!0;var c=(Ja=a.shiftKey?!0:!1)?10:1;switch(a.keyCode){case 37:X(a,-c,0);break;case 39:X(a,c,0);break;
case 38:X(a,0,-c);break;case 40:X(a,0,c);break;case 27:q.release();break;case 9:return!0}return nothing(a)}).blur(function(){Y.hide()}),n=g("<div />").css({position:"absolute",overflow:"hidden"}).append(Y);d.keySupport&&n.insertBefore(u);S={watchKeys:function(){d.keySupport&&(Y.show(),Y.focus())}};G.hide();aa(!0);n={animateTo:function(a){var c=a[0]/y,b=a[1]/A,e=a[2]/y,g=a[3]/A;if(!sa){var a=k.flipCoords(c,b,e,g),c=k.getFixed(),f=initcr=[c.x,c.y,c.x2,c.y2],j=d.animationDelay,l=f[0],n=f[1],e=f[2],g=
f[3],p=a[0]-initcr[0],s=a[1]-initcr[1],t=a[2]-initcr[2],u=a[3]-initcr[3],m=0,x=d.swingSpeed;q.animMode(!0);var v=function(){m+=(100-m)/x;f[0]=l+m/100*p;f[1]=n+m/100*s;f[2]=e+m/100*t;f[3]=g+m/100*u;100>m?window.setTimeout(v,j):q.done();99.8<=m&&(m=100);oa(f)};window.setTimeout(v,j)}},setSelect:na,setOptions:function(a){pa(a);aa()},tellSelect:function(){return $(k.getFixed())},tellScaled:function(){return k.getFixed()},disable:function(){d.disabled=!0;q.disableHandles();q.setCursor("default");z.setCursor("default")},
enable:function(){d.disabled=!1;aa()},cancel:function(){q.done();z.activateHandlers(null,null)},focus:S.watchKeys,getBounds:function(){return[t*y,s*A]},getWidgetSize:function(){return[t,s]},release:q.release,destroy:function(){ba.remove();D.show()}};D.data("Jcrop",n);return n};g.fn.Jcrop=function(v){"object"!==typeof v&&(v={});this.each(function(){if(g(this).data("Jcrop")){if("api"==v)return g(this).data("Jcrop");g(this).data("Jcrop").setOptions(v)}else{var x=this,f=v.useImg||x.src,F=new Image;F.onload=
function(){g.Jcrop(x,v)};F.src=f}});return this}})(jQuery);
